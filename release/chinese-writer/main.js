/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var j=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var Z=(P,o)=>()=>(P&&(o=P(P=0)),o);var q=(P,o)=>{for(var t in o)j(P,t,{get:o[t],enumerable:!0})},tt=(P,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of _(o))!X.call(P,i)&&i!==t&&j(P,i,{get:()=>o[i],enumerable:!(e=Y(o,i))||e.enumerable});return P};var et=P=>tt(j({},"__esModule",{value:!0}),P);var U={};q(U,{ConfirmModal:()=>k,TextInputModal:()=>E});var K,E,k,O=Z(()=>{K=require("obsidian"),E=class extends K.Modal{constructor(t,e,i,r,s){super(t);this.submitted=!1;this.title=e,this.placeholder=i,this.defaultValue=r,this.onSubmit=s}onOpen(){let{contentEl:t}=this,e=t.closest(".modal");e&&(e.style.minHeight="auto",e.style.height="auto",e.style.maxWidth="400px",e.style.width="90%"),t.style.padding="1em";let i=t.createEl("h2",{text:this.title});i.style.marginTop="0",i.style.marginBottom="0.8em",i.style.fontSize="1.2em";let r=t.createEl("input",{type:"text",placeholder:this.placeholder,value:this.defaultValue});r.style.width="100%",r.style.marginBottom="1em",r.style.padding="0.5em",r.focus(),r.select();let s=t.createDiv();s.style.display="flex",s.style.justifyContent="flex-end",s.style.gap="0.5em",s.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()});let a=s.createEl("button",{text:"\u786E\u5B9A",cls:"mod-cta"}),l=()=>{if(this.submitted)return;this.submitted=!0;let h=r.value;this.close(),setTimeout(()=>{this.onSubmit(h)},10)};a.addEventListener("click",l),r.addEventListener("keydown",h=>{h.key==="Enter"?l():h.key==="Escape"&&this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},k=class extends K.Modal{constructor(o,t,e,i){super(o),this.title=t,this.message=e,this.onConfirm=i}onOpen(){let{contentEl:o}=this,t=o.closest(".modal");t&&(t.style.minHeight="auto",t.style.height="auto",t.style.maxWidth="400px",t.style.width="90%"),o.style.padding="1em";let e=o.createEl("h2",{text:this.title});e.style.marginTop="0",e.style.marginBottom="0.8em",e.style.fontSize="1.2em";let i=o.createEl("p",{text:this.message});i.style.marginBottom="1em";let r=o.createDiv();r.style.display="flex",r.style.justifyContent="flex-end",r.style.gap="0.5em",r.style.marginTop="0.5em",r.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u786E\u5B9A",cls:"mod-warning"}).addEventListener("click",()=>{this.close(),this.onConfirm()})}onClose(){let{contentEl:o}=this;o.empty()}}});var it={};q(it,{default:()=>R});module.exports=et(it);var F=require("obsidian");var b=require("obsidian"),D={folderMappings:[],highlightStyle:{mode:"all",backgroundColor:"#FFFFFF00",borderStyle:"dotted",borderWidth:2,borderColor:"#4A86E9",fontWeight:"normal",fontStyle:"normal",color:"#4A86E9"},highlightPreviewStyle:{width:300,height:340,maxBodyLines:12},punctuationCheck:{enabled:!1,comma:!0,period:!0,colon:!0,semicolon:!0,exclamation:!0,question:!0,doubleQuote:!0,singleQuote:!0},editorIndentCjkChars:2,editorLineHeight:1.6,editorParagraphSpacing:12,enableEditorHoverPreview:!0,enableTreeH2HoverPreview:!1,openInNewTab:!0},W=class extends b.PluginSettingTab{constructor(t,e){super(t,e);this.isAddingMapping=!1;this.plugin=e}display(){let{containerEl:t}=this,e=async()=>{await this.plugin.saveSettings(),this.refreshEditorHighlight()},i=[],r=n=>{for(let a of i)a.setDisabled(n)};t.empty(),t.createEl("h2",{text:"\u4E2D\u6587\u5199\u4F5C\u63D2\u4EF6\u8BBE\u7F6E",cls:"cw-settings-main-title"}),t.createEl("h3",{text:"\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB"}),t.createEl("p",{text:"\u914D\u7F6E\u5C0F\u8BF4\u5E93\u548C\u8BBE\u5B9A\u5E93\u7684\u5BF9\u5E94\u5173\u7CFB\u3002\u5728\u5C0F\u8BF4\u5E93\u6587\u4EF6\u6253\u5F00\u65F6\uFF0C\u4F1A\u663E\u793A\u5BF9\u5E94\u8BBE\u5B9A\u5E93\u7684\u5185\u5BB9\uFF0C\u5E76\u9AD8\u4EAE\u5173\u952E\u5B57\u3002",cls:"setting-item-description"});let s=t.createDiv({cls:"folder-mappings-container"});this.renderMappings(s),new b.Setting(t).setName("\u6DFB\u52A0\u65B0\u5BF9\u5E94\u5173\u7CFB").addButton(n=>n.setButtonText("\u6DFB\u52A0").setCta().onClick(()=>{this.isAddingMapping||this.addNewMapping()})),t.createEl("h3",{text:"\u5173\u952E\u5B57\u9AD8\u4EAE\u6837\u5F0F"}),new b.Setting(t).setName("\u9AD8\u4EAE\u6A21\u5F0F").setDesc("\u9009\u62E9\u5173\u952E\u5B57\u7684\u9AD8\u4EAE\u65B9\u5F0F").addDropdown(n=>n.addOption("first","\u9996\u6B21\u9AD8\u4EAE").addOption("all","\u5168\u90E8\u9AD8\u4EAE").setValue(this.plugin.settings.highlightStyle.mode).onChange(async a=>{this.plugin.settings.highlightStyle.mode=a,await this.plugin.saveSettings(),this.refreshEditorHighlight()})),new b.Setting(t).setName("\u80CC\u666F\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u80CC\u666F\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #FFFFFF00\uFF0C\u6700\u540E\u4E24\u4F4D\u4E3A\u900F\u660E\u5EA6\uFF09").addText(n=>n.setPlaceholder("#FFFFFF00").setValue(this.plugin.settings.highlightStyle.backgroundColor).onChange(async a=>{this.plugin.settings.highlightStyle.backgroundColor=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u6837\u5F0F").addDropdown(n=>n.addOption("solid","\u5B9E\u7EBF").addOption("dashed","\u865A\u7EBF").addOption("dotted","\u70B9\u7EBF").addOption("double","\u53CC\u7EBF").addOption("wavy","\u6CE2\u6D6A\u7EBF").setValue(this.plugin.settings.highlightStyle.borderStyle).onChange(async a=>{this.plugin.settings.highlightStyle.borderStyle=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u7C97\u7EC6\uFF080-10\u50CF\u7D20\uFF09").addSlider(n=>n.setLimits(0,10,1).setValue(this.plugin.settings.highlightStyle.borderWidth).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightStyle.borderWidth=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u989C\u8272").addText(n=>n.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.borderColor).onChange(async a=>{this.plugin.settings.highlightStyle.borderColor=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u5B57\u4F53\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u7C97\u7EC6").addDropdown(n=>n.addOption("normal","\u6B63\u5E38").addOption("bold","\u7C97\u4F53").setValue(this.plugin.settings.highlightStyle.fontWeight).onChange(async a=>{this.plugin.settings.highlightStyle.fontWeight=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u5B57\u4F53\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u6837\u5F0F").addDropdown(n=>n.addOption("normal","\u6B63\u5E38").addOption("italic","\u659C\u4F53").setValue(this.plugin.settings.highlightStyle.fontStyle).onChange(async a=>{this.plugin.settings.highlightStyle.fontStyle=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u6587\u5B57\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u6587\u5B57\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #4A86E9ff\uFF0Cinherit\u8868\u793A\u7EE7\u627F\u539F\u6709\u989C\u8272\uFF09").addText(n=>n.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.color).onChange(async a=>{this.plugin.settings.highlightStyle.color=a,await this.plugin.saveSettings(),this.updateHighlightStyles()})),t.createEl("h3",{text:"\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B"}),new b.Setting(t).setName("\u542F\u7528\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B").setDesc("\u4EC5\u5728\u5DF2\u914D\u7F6E\u5C0F\u8BF4\u5E93\u4E2D\u7684 Markdown \u6587\u4EF6\u5185\u8FDB\u884C\u68C0\u6D4B").addToggle(n=>n.setValue(this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.enabled=a,await e(),r(!a)})),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u9017\u53F7\uFF08,\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.comma).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.comma=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u53E5\u53F7\uFF08.\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.period).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.period=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5192\u53F7\uFF08:\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.colon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.colon=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5206\u53F7\uFF08;\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.semicolon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.semicolon=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u611F\u53F9\u53F7\uFF08!\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.exclamation).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.exclamation=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u95EE\u53F7\uFF08?\uFF09").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.question).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.question=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u53CC\u5F15\u53F7").setDesc('\u68C0\u6D4B\u82F1\u6587\u53CC\u5F15\u53F7\uFF08"\uFF09\u4E0E\u4E2D\u6587\u53CC\u5F15\u53F7\uFF08\u201C\u201D\uFF09\u914D\u5BF9\u9519\u8BEF').addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.doubleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.doubleQuote=a,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u5355\u5F15\u53F7").setDesc("\u68C0\u6D4B\u82F1\u6587\u5355\u5F15\u53F7\uFF08'\uFF09\u4E0E\u4E2D\u6587\u5355\u5F15\u53F7\uFF08\u2018\u2019\uFF09\u914D\u5BF9\u9519\u8BEF").addToggle(n=>{i.push(n),n.setValue(this.plugin.settings.punctuationCheck.singleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async a=>{this.plugin.settings.punctuationCheck.singleQuote=a,await e()})}),t.createEl("h3",{text:"\u9884\u89C8\u680F\u8BBE\u7F6E"}),new b.Setting(t).setName("\u6B63\u6587\u60AC\u505C\u9884\u89C8").setDesc("\u5F00\u542F\u540E\uFF0C\u9F20\u6807\u60AC\u505C\u6B63\u6587\u9AD8\u4EAE\u5173\u952E\u8BCD\u65F6\u663E\u793A\u9884\u89C8\u680F").addToggle(n=>n.setValue(this.plugin.settings.enableEditorHoverPreview).onChange(async a=>{this.plugin.settings.enableEditorHoverPreview=a,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u53F3\u8FB9\u680F\u60AC\u505C\u9884\u89C8").setDesc("\u5F00\u542F\u540E\uFF0C\u9F20\u6807\u60AC\u505C\u53F3\u8FB9\u680F\u65F6\u663E\u793A\u9884\u89C8\u680F").addToggle(n=>n.setValue(this.plugin.settings.enableTreeH2HoverPreview).onChange(async a=>{this.plugin.settings.enableTreeH2HoverPreview=a,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u9884\u89C8\u680F\u5BBD\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u5BBD\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(n=>n.setLimits(240,720,20).setValue(this.plugin.settings.highlightPreviewStyle.width).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.width=a,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u9884\u89C8\u680F\u9AD8\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u6700\u5927\u9AD8\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(n=>n.setLimits(160,800,20).setValue(this.plugin.settings.highlightPreviewStyle.height).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.height=a,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u4E0B\u65B9\u5185\u5BB9\u6700\u591A\u663E\u793A\u884C\u6570").setDesc("\u8D85\u8FC7\u8BE5\u884C\u6570\u65F6\u663E\u793A\u6EDA\u52A8\u6761").addSlider(n=>n.setLimits(3,50,1).setValue(this.plugin.settings.highlightPreviewStyle.maxBodyLines).setDynamicTooltip().onChange(async a=>{this.plugin.settings.highlightPreviewStyle.maxBodyLines=a,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u6587\u4EF6\u6253\u5F00\u884C\u4E3A"}),new b.Setting(t).setName("\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00").setDesc("\u901A\u8FC7\u63D2\u4EF6\u5185\u76F8\u5173\u529F\u80FD\u6253\u5F00\u6216\u65B0\u5EFA\u6587\u4EF6\u65F6\uFF0C\u662F\u5426\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00\uFF08\u5DF2\u6253\u5F00\u5219\u590D\u7528\u73B0\u6709\u6807\u7B7E\uFF09").addToggle(n=>n.setValue(this.plugin.settings.openInNewTab).onChange(async a=>{this.plugin.settings.openInNewTab=a,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u7F16\u8F91\u533A\u6392\u7248"}),new b.Setting(t).setName("\u884C\u9996\u7F29\u8FDB\uFF08\u4E2D\u6587\u5B57\u7B26\uFF09").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548\uFF0C\u6309\u4E2D\u6587\u5B57\u7B26\u5BBD\u5EA6\u7F29\u8FDB").addSlider(n=>n.setLimits(0,6,.5).setValue(this.plugin.settings.editorIndentCjkChars).setDynamicTooltip().onChange(async a=>{this.plugin.settings.editorIndentCjkChars=a,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),new b.Setting(t).setName("\u884C\u95F4\u8DDD").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548").addSlider(n=>n.setLimits(1.2,2.6,.1).setValue(this.plugin.settings.editorLineHeight).setDynamicTooltip().onChange(async a=>{this.plugin.settings.editorLineHeight=a,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),new b.Setting(t).setName("\u6BB5\u95F4\u8DDD").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548\uFF1B\u4E0E\u884C\u95F4\u8DDD\u72EC\u7ACB\uFF0C\u4E0D\u53E0\u52A0").addSlider(n=>n.setLimits(0,32,1).setValue(this.plugin.settings.editorParagraphSpacing).setDynamicTooltip().onChange(async a=>{this.plugin.settings.editorParagraphSpacing=a,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()}))}renderMappings(t){if(t.empty(),this.plugin.settings.folderMappings.length===0){t.createEl("p",{text:"\u6682\u65E0\u5BF9\u5E94\u5173\u7CFB\uFF0C\u8BF7\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u6DFB\u52A0\u3002",cls:"setting-item-description"});return}this.plugin.settings.folderMappings.forEach((e,i)=>{let r=`${e.novelFolder||"\u672A\u8BBE\u7F6E"} \u2192 ${e.settingFolder||"\u672A\u8BBE\u7F6E"}`;new b.Setting(t).setName(r).setClass("folder-mapping-item").addButton(s=>s.setButtonText("\u7F16\u8F91").onClick(async()=>{await this.editMapping(e)})).addButton(s=>s.setButtonText("\u5220\u9664").setWarning().onClick(async()=>{e.settingFolder&&await this.plugin.orderManager.removeFolderData(e.settingFolder),this.plugin.settings.folderMappings=this.plugin.settings.folderMappings.filter(n=>n.id!==e.id),await this.plugin.saveSettings(),await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()}))})}async editMapping(t){let{TextInputModal:e}=await Promise.resolve().then(()=>(O(),U)),i=t.settingFolder;new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.novelFolder,async r=>{r.trim()&&setTimeout(()=>{new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.settingFolder,async s=>{s.trim()&&(t.novelFolder=r.trim(),t.settingFolder=s.trim(),i&&await this.plugin.orderManager.removeFolderData(i),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()},50))}).open()},100)}).open()}async addNewMapping(){if(this.isAddingMapping)return;this.isAddingMapping=!0;let{TextInputModal:t}=await Promise.resolve().then(()=>(O(),U));new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async e=>{if(!e.trim()){this.isAddingMapping=!1;return}setTimeout(()=>{new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async i=>{if(!i.trim()){this.isAddingMapping=!1;return}let r={id:Date.now().toString(),novelFolder:e.trim(),settingFolder:i.trim()};this.plugin.settings.folderMappings.push(r),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display(),this.isAddingMapping=!1},50)}).open()},100)}).open()}updateHighlightStyles(){this.plugin.highlightManager&&this.plugin.highlightManager.updateStyles()}refreshEditorHighlight(){this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}updateEditorTypographyStyles(){this.plugin.editorTypographyManager&&this.plugin.editorTypographyManager.updateStyles()}};var G=require("obsidian"),A=class{constructor(o){this.parseCache=new Map;this.vault=o}async parseFolder(o){let t=[],e=this.vault.getAbstractFileByPath(o);if(!e||!(e instanceof G.TFile)){let r=this.vault.getMarkdownFiles().filter(s=>s.path.startsWith(o));for(let s of r){let n=await this.parseFile(s);n&&t.push(n)}}return t}async parseFile(o){if(o.extension!=="md")return null;let t=this.parseCache.get(o.path);if(t&&t.mtime===o.stat.mtime&&t.size===o.stat.size)return t.result;let i=(await this.vault.read(o)).split(`
`),r=[],s=null,n=null;for(let l=0;l<i.length;l++){let h=i[l];if(!h)continue;let c=h.trim();c.startsWith("# ")&&!c.startsWith("## ")?(n&&s&&(s.h2List.push(n),n=null),s&&r.push(s),s={text:c.substring(2).trim(),lineNumber:l,h2List:[]}):c.startsWith("## ")&&!c.startsWith("### ")&&s?(n&&s.h2List.push(n),n={text:c.substring(3).trim(),lineNumber:l,content:[]}):n&&h&&c.length>0&&n.content.push(h)}n&&s&&s.h2List.push(n),s&&r.push(s);let a={filePath:o.path,fileName:o.basename,h1List:r};return this.parseCache.set(o.path,{mtime:o.stat.mtime,size:o.stat.size,result:a}),a}getMarkdownFilesInFolder(o){return this.vault.getMarkdownFiles().filter(e=>o===""?!0:e.path.startsWith(o+"/")||e.path===o)}};var x=require("obsidian"),J=require("@codemirror/view");O();var C="chinese-writer-tree-view",L=class extends x.ItemView{constructor(t,e){super(t);this.treeData=[];this.allExpanded=!1;this.lastObservedActiveFilePath=null;this.currentSettingFolder=null;this.draggedNode=null;this.dropIndicator=null;this.insertBefore=!1;this.plugin=e}getViewType(){return C}getDisplayText(){return"\u4E2D\u6587\u5199\u4F5C"}getIcon(){return"book-type"}async onOpen(){var t,e;await this.refresh(),this.lastObservedActiveFilePath=(e=(t=this.getContextFile())==null?void 0:t.path)!=null?e:null,this.registerEvent(this.app.workspace.on("active-leaf-change",async i=>{var s,n;let r=this.lastObservedActiveFilePath;(i==null?void 0:i.view)instanceof x.MarkdownView&&(r=(n=(s=i.view.file)==null?void 0:s.path)!=null?n:null),r!==this.lastObservedActiveFilePath&&(this.lastObservedActiveFilePath=r,await this.smartUpdate())}))}async onClose(){this.removeDropIndicator()}async refresh(){let t=this.containerEl.children[1];if(!t)return;t.empty(),t.addClass("chinese-writer-view");let e=t.createDiv({cls:"chinese-writer-header"}),i=e.createDiv({cls:"chinese-writer-title"}),r=i.createSpan({cls:"chinese-writer-icon"});(0,x.setIcon)(r,"book-type");let s=this.getContextFile(),n="\u672A\u8BBE\u7F6E\u76EE\u5F55";if(s){let h=this.plugin.highlightManager.getSettingFolderForFile(s.path);h&&(n=this.getFolderDisplayName(h))}i.createSpan({text:n,cls:"chinese-writer-folder-name"});let a=e.createEl("button",{cls:"chinese-writer-toggle-btn"});(0,x.setIcon)(a,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down"),a.setAttribute("aria-label","\u5C55\u5F00/\u6298\u53E0\u5168\u90E8"),a.addEventListener("click",()=>{this.toggleAllNodes()});let l=t.createDiv({cls:"chinese-writer-tree-container"});l.addEventListener("contextmenu",h=>{let c=h.target;(c.classList.contains("chinese-writer-tree-container")||c.classList.contains("chinese-writer-tree")||c.classList.contains("chinese-writer-empty"))&&(h.preventDefault(),h.stopPropagation(),this.showEmptyAreaContextMenu(h))}),await this.loadData(),this.renderTree(l,this.treeData)}async smartUpdate(){let t=this.saveExpandedStates();await this.persistExpandedStatesForCurrentFolder(t),await this.loadData(),this.restoreExpandedStates(t);let e=this.containerEl.children[1];if(!e)return;this.updateHeaderFolderName(e);let i=e.querySelector(".chinese-writer-tree-container");i&&(i.empty(),this.renderTree(i,this.treeData))}saveExpandedStates(){let t=new Map;return this.collectExpandedStates(this.treeData,t),t}collectExpandedStates(t,e,i=""){t.forEach(r=>{if(r.children.length===0)return;let s=this.getNodeKey(r,i);e.set(s,r.expanded),this.collectExpandedStates(r.children,e,s)})}getNodeKey(t,e=""){let i="";return t.type==="file"&&t.filePath?i=`file:${t.filePath}`:t.type==="h1"?i=`${e}>>h1:${t.text}`:t.type==="h2"?i=`${e}>>h2:${t.text}`:i=t.id,i}restoreExpandedStates(t){this.applyExpandedStates(this.treeData,t,"")}applyExpandedStates(t,e,i=""){t.forEach(r=>{let s=this.getNodeKey(r,i),n=e.get(s);n!==void 0&&(r.expanded=n),r.children.length>0&&this.applyExpandedStates(r.children,e,s)})}async loadData(){let t=this.getContextFile(),e=null;if(t&&(e=this.plugin.highlightManager.getSettingFolderForFile(t.path)),this.currentSettingFolder=e,!e){this.treeData=[];return}let i=this.plugin.parser,r=i.getMarkdownFilesInFolder(e),n=(await Promise.all(r.map(d=>i.parseFile(d)))).filter(d=>d!==null),a=this.plugin.orderManager.getFileOrder();a.length===0&&n.length>0&&(a=n.map(d=>d.filePath),await this.plugin.orderManager.setFileOrder(a)),a.length>0&&n.sort((d,p)=>{let g=a.indexOf(d.filePath),u=a.indexOf(p.filePath);return g===-1&&u===-1?0:g===-1?1:u===-1?-1:g-u}),this.treeData=[];let l=0;for(let d of n){let p=this.createFileNode(d,l++);this.treeData.push(p)}let h=this.plugin.orderManager.getExpandedStates(e),c=Object.entries(h);c.length>0&&this.restoreExpandedStates(new Map(c))}createFileNode(t,e){let i={id:`file-${e}`,text:t.fileName,type:"file",children:[],expanded:!1,filePath:t.filePath};return t.h1List.forEach((r,s)=>{let n={id:`${i.id}-h1-${s}`,text:r.text,type:"h1",children:[],expanded:!1};r.h2List.forEach((a,l)=>{let h=this.extractStatusFromLines(a.content),c={id:`${n.id}-h2-${l}`,text:a.text,type:"h2",children:[],expanded:!1,content:a.content,status:h};n.children.push(c)}),i.children.push(n)}),i}renderTree(t,e){if(e.length===0){t.createDiv({text:"\u672A\u627E\u5230\u6587\u4EF6\u6216\u76EE\u5F55\u4E3A\u7A7A",cls:"chinese-writer-empty"});return}let i=t.createEl("ul",{cls:"chinese-writer-tree"});e.forEach(r=>{this.renderNode(i,r)})}renderNode(t,e){let i=t.createEl("li",{cls:"tree-item"});i.setAttribute("data-node-id",e.id),i.setAttribute("data-node-type",e.type);let r=i.createDiv({cls:"tree-item-content"});if(r.setAttribute("draggable","true"),r.addEventListener("dragstart",l=>{l.stopPropagation(),this.onDragStart(l,e)}),r.addEventListener("dragover",l=>{l.stopPropagation(),this.onDragOver(l,e)}),r.addEventListener("dragleave",l=>{l.stopPropagation(),this.onDragLeave(l)}),r.addEventListener("drop",l=>{l.stopPropagation(),this.onDrop(l,e)}),r.addEventListener("dragend",l=>{l.stopPropagation(),this.onDragEnd(l)}),e.children.length>0){let l=r.createSpan({cls:"tree-item-toggle"});(0,x.setIcon)(l,e.expanded?"chevron-down":"chevron-right"),l.addEventListener("click",h=>{h.stopPropagation(),this.toggleNode(e,i)})}else r.createSpan({cls:"tree-item-toggle-placeholder"});let s=r.createSpan({cls:"tree-item-icon"}),n=e.type==="file"?"file-text":e.type==="h1"?"heading-1":"heading-2";(0,x.setIcon)(s,n),s.addEventListener("click",l=>{l.stopPropagation()});let a=r.createSpan({text:e.text,cls:`tree-item-text tree-item-${e.type}`});if(e.type==="h2"&&this.isDeadStatus(e.status)&&a.addClass("tree-item-h2-dead"),e.type==="h2"){let l=this.findParentH1Node(e),h=this.findParentFileNode(e);this.currentSettingFolder&&l&&(h!=null&&h.filePath)&&(r.addClass("cw-tree-preview-anchor"),r.setAttribute("data-cw-tree-setting-folder",this.currentSettingFolder),r.setAttribute("data-cw-tree-file-path",h.filePath),r.setAttribute("data-cw-tree-h1",l.text),r.setAttribute("data-cw-tree-h2",e.text),r.setAttribute("data-cw-tree-keyword",e.text))}if(e.type==="file"||e.type==="h1"){let l=this.countH2(e);if(l>0){let h=r.createSpan({text:`[${l}]`,cls:"tree-item-count"})}}if(r.addEventListener("click",()=>{this.onNodeClick(e)}),r.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),this.showContextMenu(l,e)}),e.children.length>0){let l=i.createEl("ul",{cls:"tree-item-children"});e.expanded||(l.style.display="none"),e.children.forEach(h=>{this.renderNode(l,h)})}}toggleNode(t,e){t.expanded=!t.expanded;let i=e.querySelector(".tree-item-toggle"),r=e.querySelector(".tree-item-children");i&&(i.empty(),(0,x.setIcon)(i,t.expanded?"chevron-down":"chevron-right")),r&&(r.style.display=t.expanded?"block":"none"),this.persistExpandedStatesForCurrentFolder()}toggleAllNodes(){this.allExpanded=!this.allExpanded,this.setAllNodesExpanded(this.treeData,this.allExpanded),this.updateAllNodesInDOM(this.allExpanded);let t=this.containerEl.children[1];if(!t)return;let e=t.querySelector(".chinese-writer-toggle-btn");e&&(e.empty(),(0,x.setIcon)(e,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down")),this.persistExpandedStatesForCurrentFolder()}setAllNodesExpanded(t,e){t.forEach(i=>{i.expanded=e,i.children.length>0&&this.setAllNodesExpanded(i.children,e)})}updateAllNodesInDOM(t){let e=this.containerEl.children[1];if(!e)return;e.querySelectorAll(".tree-item").forEach(r=>{let s=r.getAttribute("data-node-id");if(!s)return;let n=this.findNodeById(this.treeData,s);if(!n||n.children.length===0)return;let a=r.querySelector(".tree-item-toggle");a&&(a.empty(),(0,x.setIcon)(a,t?"chevron-down":"chevron-right"));let l=r.querySelector(".tree-item-children");l&&(l.style.display=t?"block":"none")})}findNodeById(t,e){for(let i of t){if(i.id===e)return i;if(i.children.length>0){let r=this.findNodeById(i.children,e);if(r)return r}}return null}countH2(t){let e=0;return t.type==="file"?t.children.forEach(i=>{e+=i.children.length}):t.type==="h1"&&(e=t.children.length),e}onNodeClick(t){}getContextFile(){let t=this.app.workspace.getActiveFile();if(t)return t;if(this.lastObservedActiveFilePath){let e=this.app.vault.getAbstractFileByPath(this.lastObservedActiveFilePath);if(e instanceof x.TFile)return e}return null}extractStatusFromLines(t){let e="\u3010\u72B6\u6001\u3011";for(let i of t){let r=i.indexOf(e);if(r===-1)continue;let s=i.slice(r+e.length).trim();if(s)return s}return""}isDeadStatus(t){if(!t)return!1;let e=t.trim();return e==="\u6B7B\u4EA1"||e==="\u5931\u6548"}updateHeaderFolderName(t){let e=t.querySelector(".chinese-writer-folder-name");e&&e.setText(this.getFolderDisplayName(this.currentSettingFolder))}getFolderDisplayName(t){var i;if(!t)return"\u672A\u8BBE\u7F6E\u76EE\u5F55";let e=t.split(/[\\/]/).map(r=>r.trim()).filter(r=>r.length>0);return(i=e[e.length-1])!=null?i:"\u672A\u8BBE\u7F6E\u76EE\u5F55"}async persistExpandedStatesForCurrentFolder(t){if(!this.currentSettingFolder)return;let e=t!=null?t:this.saveExpandedStates(),i={};e.forEach((r,s)=>{i[s]=r}),await this.plugin.orderManager.setExpandedStates(this.currentSettingFolder,i)}onDragStart(t,e){this.draggedNode=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.id),this.createDropIndicator()}onDragOver(t,e){if(t.preventDefault(),!this.draggedNode)return;if(this.draggedNode.type==="h1"&&e.type==="file"){t.dataTransfer.dropEffect="move";let n=t.currentTarget;this.showDropIndicator(n,!1);return}if(this.draggedNode.type==="h2"&&e.type==="h1"){t.dataTransfer.dropEffect="move";let n=t.currentTarget;this.showDropIndicator(n,!1);return}if(e.type!==this.draggedNode.type){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}if(e.id===this.draggedNode.id){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}t.dataTransfer.dropEffect="move";let i=t.currentTarget,r=i.getBoundingClientRect(),s=r.top+r.height/2;this.insertBefore=t.clientY<s,this.showDropIndicator(i,this.insertBefore)}createDropIndicator(){this.dropIndicator||(this.dropIndicator=document.createElement("div"),this.dropIndicator.addClass("drop-indicator"),document.body.appendChild(this.dropIndicator))}showDropIndicator(t,e){if(!this.dropIndicator||!this.draggedNode)return;let i=t.getBoundingClientRect();this.dropIndicator.style.display="block",this.dropIndicator.style.left=`${i.left}px`,this.dropIndicator.style.width=`${i.width}px`,e?this.dropIndicator.style.top=`${i.top-1}px`:this.dropIndicator.style.top=`${i.bottom-1}px`}onDragLeave(t){let e=t.currentTarget,i=t.relatedTarget;e.contains(i)}hideDropIndicator(){this.dropIndicator&&(this.dropIndicator.style.display="none")}removeDropIndicator(){this.dropIndicator&&(this.dropIndicator.remove(),this.dropIndicator=null)}async onDrop(t,e){if(t.preventDefault(),t.stopPropagation(),this.hideDropIndicator(),!(!this.draggedNode||this.draggedNode.id===e.id)){if(this.draggedNode.type==="h1"&&e.type==="file"){await this.moveH1ToFileEnd(this.draggedNode,e);return}if(this.draggedNode.type==="h2"&&e.type==="h1"){await this.moveH2ToH1End(this.draggedNode,e);return}this.draggedNode.type===e.type&&await this.reorderNodes(this.draggedNode,e)}}onDragEnd(t){t.currentTarget.removeClass("dragging"),this.removeDropIndicator(),this.draggedNode=null}async moveH2ToH1End(t,e){let i=this.findParentH1Node(t),r=this.findParentFileNode(t),s=this.findParentFileNode(e);!i||!r||!s||i.id!==e.id&&(!r.filePath||!s.filePath||(await this.plugin.orderManager.moveH2ToEndOfH1(r.filePath,i.text,s.filePath,e.text,t.text),await this.smartUpdate()))}async moveH1ToFileEnd(t,e){let i=this.findParentFileNode(t);i&&i.id!==e.id&&(!i.filePath||!e.filePath||(await this.plugin.orderManager.moveH1ToEndOfFile(i.filePath,e.filePath,t.text),await this.smartUpdate()))}async reorderNodes(t,e){t.type==="file"?await this.reorderFiles(t,e):t.type==="h1"?await this.reorderH1(t,e):t.type==="h2"&&await this.reorderH2(t,e)}async reorderFiles(t,e){if(!t.filePath||!e.filePath)return;let i=this.treeData.map(a=>a.filePath).filter(a=>a!==void 0),r=i.indexOf(t.filePath),s=i.indexOf(e.filePath);if(r===-1||s===-1)return;let[n]=i.splice(r,1);n&&(s=i.indexOf(e.filePath),this.insertBefore?i.splice(s,0,n):i.splice(s+1,0,n),await this.plugin.orderManager.setFileOrder(i),await this.smartUpdate())}async reorderH1(t,e){let i=this.findParentFileNode(t),r=this.findParentFileNode(e);if(!i||!r)return;if(i.id===r.id){if(!i.filePath)return;let n=i.children.map(c=>c.text),a=n.indexOf(t.text),l=n.indexOf(e.text);if(a===-1||l===-1)return;let[h]=n.splice(a,1);if(!h)return;l=n.indexOf(e.text),this.insertBefore?n.splice(l,0,h):n.splice(l+1,0,h),await this.plugin.orderManager.reorderH1InFile(i.filePath,n)}else{if(!i.filePath||!r.filePath)return;await this.plugin.orderManager.moveH1BetweenFiles(i.filePath,r.filePath,t.text,e.text,this.insertBefore)}await this.smartUpdate()}async reorderH2(t,e){let i=this.findParentH1Node(t),r=this.findParentH1Node(e),s=this.findParentFileNode(t),n=this.findParentFileNode(e);if(!i||!r||!s||!n)return;if(i.id===r.id){if(!s.filePath)return;let l=i.children.map(p=>p.text),h=l.indexOf(t.text),c=l.indexOf(e.text);if(h===-1||c===-1)return;let[d]=l.splice(h,1);if(!d)return;c=l.indexOf(e.text),this.insertBefore?l.splice(c,0,d):l.splice(c+1,0,d),await this.plugin.orderManager.reorderH2InFile(s.filePath,i.text,l)}else{if(!s.filePath||!n.filePath)return;await this.plugin.orderManager.moveH2BetweenH1s(s.filePath,i.text,n.filePath,r.text,t.text,e.text,this.insertBefore)}await this.smartUpdate()}findParentFileNode(t){let e=t.id.match(/^file-(\d+)/);if(!e||!e[1])return null;let i=parseInt(e[1]);return this.treeData[i]||null}findParentH1Node(t){let e=t.id.match(/^file-(\d+)-h1-(\d+)/);if(!e||!e[1]||!e[2])return null;let i=parseInt(e[1]),r=parseInt(e[2]),s=this.treeData[i];return s&&s.children[r]||null}showContextMenu(t,e){let i=new x.Menu;e.type==="file"?this.addH1ContextMenu(i,e):e.type==="h1"?this.addH2ContextMenu(i,e):e.type==="h2"&&this.addH2SelfContextMenu(i,e),i.showAtMouseEvent(t)}showEmptyAreaContextMenu(t){let e=new x.Menu;this.addFileContextMenuForEmpty(e),e.showAtMouseEvent(t)}addFileContextMenuForEmpty(t){t.addItem(e=>{e.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})})}addH1ContextMenu(t,e){t.addItem(i=>{i.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})}),t.addItem(i=>{i.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(e)})}),t.addSeparator(),t.addItem(i=>{i.setTitle("\u91CD\u547D\u540D\u96C6\u5408").setIcon("pencil").onClick(async()=>{await this.renameFile(e)})}),t.addItem(i=>{i.setTitle("\u5220\u9664\u96C6\u5408").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteFile(e)})})}addH2ContextMenu(t,e){let i=this.findParentFileNode(e);i&&t.addItem(r=>{r.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(i)})}),t.addItem(r=>{r.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(e)})}),t.addSeparator(),t.addItem(r=>{r.setTitle("\u91CD\u547D\u540D\u5206\u7C7B").setIcon("pencil").onClick(async()=>{await this.renameH1(e)})}),t.addItem(r=>{r.setTitle("\u5220\u9664\u5206\u7C7B").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH1(e)})})}addH2SelfContextMenu(t,e){let i=this.findParentH1Node(e);i&&t.addItem(r=>{r.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(i)})}),t.addItem(r=>{r.setTitle("\u7F16\u8F91\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.editH2(e)})}),t.addSeparator(),t.addItem(r=>{r.setTitle("\u91CD\u547D\u540D\u8BBE\u5B9A").setIcon("pencil").onClick(async()=>{await this.renameH2(e)})}),t.addItem(r=>{r.setTitle("\u5220\u9664\u8BBE\u5B9A").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH2(e)})})}async createFile(){new E(this.app,"\u521B\u5EFA\u96C6\u5408","\u8BF7\u8F93\u5165\u96C6\u5408\u540D\u79F0","",async e=>{if(!e.trim())return;let i=this.app.workspace.getActiveFile(),r=null;if(i&&(r=this.plugin.highlightManager.getSettingFolderForFile(i.path)),!r)return;let s=e.trim(),n=`${r}/${s}.md`;if(this.app.vault.getAbstractFileByPath(n))return;let l=await this.app.vault.create(n,"");await this.plugin.openFileWithSettings(l);let h=this.plugin.orderManager.getFileOrder();h.length===0?h=this.plugin.parser.getMarkdownFilesInFolder(r).map(p=>p.path):h.push(n),await this.plugin.orderManager.setFileOrder(h),await new Promise(c=>setTimeout(c,400)),await this.smartUpdate()}).open()}async renameFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof x.TFile))return;new E(this.app,"\u91CD\u547D\u540D\u96C6\u5408","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async r=>{if(!r.trim()||r.trim()===t.text)return;let s=r.trim(),a=`${t.filePath.substring(0,t.filePath.lastIndexOf("/"))}/${s}.md`;await this.app.fileManager.renameFile(e,a);let l=this.plugin.orderManager.getFileOrder(),h=l.indexOf(t.filePath);h!==-1&&(l[h]=a,await this.plugin.orderManager.setFileOrder(l)),await this.smartUpdate()}).open()}async deleteFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof x.TFile))return;new k(this.app,"\u5220\u9664\u96C6\u5408",`\u786E\u5B9A\u8981\u5220\u9664\u96C6\u5408"${t.text}"\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let r=this.plugin.orderManager.getFileOrder();if(r.length===0){let n=this.app.workspace.getActiveFile(),a=null;n&&(a=this.plugin.highlightManager.getSettingFolderForFile(n.path)),a&&(r=this.plugin.parser.getMarkdownFilesInFolder(a).map(c=>c.path))}await this.app.vault.delete(e);let s=r.indexOf(t.filePath);s!==-1&&(r.splice(s,1),await this.plugin.orderManager.setFileOrder(r)),await new Promise(n=>setTimeout(n,400)),await this.smartUpdate()}).open()}async createH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new E(this.app,"\u521B\u5EFA\u5206\u7C7B","\u8BF7\u8F93\u5165\u5206\u7C7B\u540D\u79F0","",async r=>{if(!r.trim())return;let s=r.trim(),n=this.app.vault.getAbstractFileByPath(e.filePath);if(!(n instanceof x.TFile))return;let l=(await this.app.vault.read(n)).split(`
`);l.push(`# ${s}`),await this.app.vault.modify(n,l.join(`
`)),await this.smartUpdate()}).open()}async renameH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new E(this.app,"\u91CD\u547D\u540D\u5206\u7C7B","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async r=>{if(!r.trim()||r.trim()===t.text)return;let s=r.trim(),n=this.app.vault.getAbstractFileByPath(e.filePath);if(!(n instanceof x.TFile))return;let l=(await this.app.vault.read(n)).split(`
`);for(let h=0;h<l.length;h++){let c=l[h];if(!c)continue;let d=c.trim();if(d.startsWith("# ")&&!d.startsWith("## ")&&d.substring(2).trim()===t.text){l[h]=`# ${s}`;break}}await this.app.vault.modify(n,l.join(`
`)),await this.smartUpdate()}).open()}async deleteH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new k(this.app,"\u5220\u9664\u5206\u7C7B",`\u786E\u5B9A\u8981\u5220\u9664\u5206\u7C7B"${t.text}"\u53CA\u5176\u4E0B\u7684\u6240\u6709\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let r=this.app.vault.getAbstractFileByPath(e.filePath);if(!(r instanceof x.TFile))return;let n=(await this.app.vault.read(r)).split(`
`),a=-1,l=n.length,h=!1;for(let d=0;d<n.length;d++){let p=n[d];if(!p)continue;let g=p.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(g.substring(2).trim()===t.text)a=d,h=!0;else if(h){l=d;break}}}if(a===-1)return;let c=[...n.slice(0,a),...n.slice(l)];await this.app.vault.modify(r,c.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async createH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new E(this.app,"\u521B\u5EFA\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u540D\u79F0","",async s=>{if(!s.trim())return;let n=s.trim(),a=this.app.vault.getAbstractFileByPath(i.filePath);if(!(a instanceof x.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=h.length,d=!1;for(let g=0;g<h.length;g++){let u=h[g];if(!u)continue;let v=u.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(v.substring(2).trim()===e.text)d=!0;else if(d){c=g;break}}}let p=[...h.slice(0,c),`## ${n}`,...h.slice(c)];await this.app.vault.modify(a,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async renameH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new E(this.app,"\u91CD\u547D\u540D\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async s=>{if(!s.trim()||s.trim()===t.text)return;let n=s.trim(),a=this.app.vault.getAbstractFileByPath(i.filePath);if(!(a instanceof x.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=!1;for(let d=0;d<h.length;d++){let p=h[d];if(!p)continue;let g=p.trim();if(g.startsWith("# ")&&!g.startsWith("## "))c=g.substring(2).trim()===e.text;else if(c&&g.startsWith("## ")&&!g.startsWith("### ")&&g.substring(3).trim()===t.text){h[d]=`## ${n}`;break}}await this.app.vault.modify(a,h.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async deleteH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new k(this.app,"\u5220\u9664\u8BBE\u5B9A",`\u786E\u5B9A\u8981\u5220\u9664\u8BBE\u5B9A"${t.text}"\u53CA\u5176\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let s=this.app.vault.getAbstractFileByPath(i.filePath);if(!(s instanceof x.TFile))return;let a=(await this.app.vault.read(s)).split(`
`),l=-1,h=a.length,c=!1,d=!1;for(let g=0;g<a.length;g++){let u=a[g];if(!u)continue;let v=u.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(c=v.substring(2).trim()===e.text,c===!1&&d){h=g;break}}else if(c&&v.startsWith("## ")&&!v.startsWith("### ")){if(v.substring(3).trim()===t.text)l=g,d=!0;else if(d){h=g;break}}}if(l===-1)return;let p=[...a.slice(0,l),...a.slice(h)];await this.app.vault.modify(s,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async editH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;let r=this.app.vault.getAbstractFileByPath(i.filePath);if(!(r instanceof x.TFile))return;let n=(await this.app.vault.read(r)).split(`
`),a=this.findFirstContentLine(n,e.text,t.text),l=await this.plugin.openFileWithSettings(r,{revealWhenNewTab:!0});if(!l)return;let h=l.view instanceof x.MarkdownView?l.view:null;h!=null&&h.editor&&(h.editor.setCursor({line:a,ch:0}),this.centerEditorLine(h.editor,a))}centerEditorLine(t,e){let i=t.cm;if(!i)return;let r=Math.max(0,Math.min(e,i.state.doc.lines-1)),s=i.state.doc.line(r+1).from,n=()=>{i.dispatch({effects:J.EditorView.scrollIntoView(s,{y:"center",yMargin:0})})};n(),window.setTimeout(n,30)}findFirstContentLine(t,e,i){var a,l;let r=!1,s=!1,n=0;for(let h=0;h<t.length;h++){let c=(l=(a=t[h])==null?void 0:a.trim())!=null?l:"";if(c.startsWith("# ")&&!c.startsWith("## ")){r=c.slice(2).trim()===e,s=!1;continue}if(r&&c.startsWith("## ")&&!c.startsWith("### ")){s=c.slice(3).trim()===i,s&&(n=h);continue}if(s){if(c.startsWith("#"))break;if(c.length>0)return h}}return n}};var S=require("obsidian"),B=class{constructor(o,t){this.saveTimeout=null;this.isSaving=!1;this.app=o,this.viewDataFilePath=`${t}/cw-view-datas.json`,this.legacyViewDataFilePath=`${t}/view-datas.json`,this.legacyOrderFilePath=`${t}/order.json`,this.orderData={files:[],expandedStatesByFolder:{}}}async load(){try{let o=this.app.vault.adapter,t=await o.exists(this.viewDataFilePath),e=await o.exists(this.legacyViewDataFilePath),i=await o.exists(this.legacyOrderFilePath),r=this.viewDataFilePath;if(!t&&e?r=this.legacyViewDataFilePath:!t&&i&&(r=this.legacyOrderFilePath),!await o.exists(r)){this.orderData={files:[],expandedStatesByFolder:{}};return}let n=await o.read(r),a=JSON.parse(n),l=Array.isArray(a==null?void 0:a.files)?a.files.filter(c=>typeof c=="string"&&c.length>0):[],h={};if(a!=null&&a.expandedStatesByFolder&&typeof a.expandedStatesByFolder=="object")for(let[c,d]of Object.entries(a.expandedStatesByFolder)){if(!d||typeof d!="object")continue;let p={};for(let[g,u]of Object.entries(d))typeof u=="boolean"&&(g.includes(">>h2:")||(p[g]=u));h[c]=p}this.orderData={files:l,expandedStatesByFolder:h},r===this.legacyOrderFilePath&&!t&&await this.saveNow(),r===this.legacyViewDataFilePath&&!t&&await this.saveNow()}catch(o){this.orderData={files:[],expandedStatesByFolder:{}}}}async save(){return this.saveTimeout&&clearTimeout(this.saveTimeout),new Promise(o=>{this.saveTimeout=setTimeout(async()=>{await this.saveNow(),o()},300)})}async saveNow(){if(this.isSaving)return await new Promise(o=>setTimeout(o,100)),this.saveNow();this.isSaving=!0;try{let o=JSON.stringify(this.orderData,null,2),t=this.app.vault.adapter;if(await t.exists(this.viewDataFilePath))await t.write(this.viewDataFilePath,o);else{let i=this.viewDataFilePath.substring(0,this.viewDataFilePath.lastIndexOf("/"));i&&!await t.exists(i)&&await t.mkdir(i),await t.write(this.viewDataFilePath,o)}}catch(o){console.error("Failed to save order data:",o)}finally{this.isSaving=!1}}getFileOrder(){return this.orderData.files}async setFileOrder(o){this.orderData.files=o,await this.save()}getExpandedStates(o){var t;return(t=this.orderData.expandedStatesByFolder[o])!=null?t:{}}async setExpandedStates(o,t){this.orderData.expandedStatesByFolder[o]=t,await this.save()}async removeFolderData(o){this.orderData.expandedStatesByFolder[o]&&delete this.orderData.expandedStatesByFolder[o],await this.save()}async reorderH1InFile(o,t){let e=this.app.vault.getAbstractFileByPath(o);if(!(e instanceof S.TFile))return;let r=(await this.app.vault.read(e)).split(`
`),s=new Map,n=null,a=[],l=[],h=!0;for(let p of r){let g=p.trim();g.startsWith("# ")&&!g.startsWith("## ")?(n?s.set(n,a):h&&(l=a,h=!1),n=g.substring(2).trim(),a=[p]):a.push(p)}n&&s.set(n,a);let c=[...l];for(let p of t){let g=s.get(p);g&&c.push(...g)}let d=c.join(`
`);await this.app.vault.modify(e,d)}async reorderH2InFile(o,t,e){let i=this.app.vault.getAbstractFileByPath(o);if(!(i instanceof S.TFile))return;let s=(await this.app.vault.read(i)).split(`
`),n=-1,a=s.length,l=!1;for(let f=0;f<s.length;f++){let w=s[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")){if(y.substring(2).trim()===t)n=f,l=!0;else if(l){a=f;break}}}if(n===-1)return;let h=new Map,c=null,d=[],p=[],g=!0;for(let f=n;f<a;f++){let w=s[f];if(w===void 0)continue;let y=w.trim();if(f===n){p.push(w);continue}y.startsWith("## ")&&!y.startsWith("### ")?(c?h.set(c,d):g&&(p.push(...d),g=!1),c=y.substring(3).trim(),d=[w]):d.push(w)}c?h.set(c,d):d.length>0&&p.push(...d);let u=[...p];for(let f of e){let w=h.get(f);w&&u.push(...w)}let m=[...s.slice(0,n),...u,...s.slice(a)].join(`
`);await this.app.vault.modify(i,m)}async moveH1BetweenFiles(o,t,e,i,r=!1){let s=this.app.vault.getAbstractFileByPath(o);if(!(s instanceof S.TFile))return;let a=(await this.app.vault.read(s)).split(`
`),l=[],h=!1,c=!1;for(let f of a){let w=f.trim();if(w.startsWith("# ")&&!w.startsWith("## ")){if(w.substring(2).trim()===e)c=!0,h=!0,l.push(f);else if(c)break}else c&&l.push(f)}if(!h)return;let d=a.filter((f,w)=>{let y=f.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===e)return!1;let H=f;return!l.includes(H)});await this.app.vault.modify(s,d.join(`
`));let p=this.app.vault.getAbstractFileByPath(t);if(!(p instanceof S.TFile))return;let u=(await this.app.vault.read(p)).split(`
`),v=u.length;for(let f=0;f<u.length;f++){let w=u[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===i){if(r)v=f;else for(let N=f+1;N<u.length;N++){let z=u[N];if(!z)continue;let Q=z.trim();if(Q.startsWith("# ")&&!Q.startsWith("## ")){v=N;break}}break}}let m=[...u.slice(0,v),...l,...u.slice(v)];await this.app.vault.modify(p,m.join(`
`))}async moveH1ToEndOfFile(o,t,e){if(o===t)return;let i=this.app.vault.getAbstractFileByPath(o);if(!(i instanceof S.TFile))return;let s=(await this.app.vault.read(i)).split(`
`),n=[],a=!1;for(let g of s){let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(u.substring(2).trim()===e){a=!0,n.push(g);continue}if(a)break}a&&n.push(g)}if(n.length===0)return;let l=[];a=!1;for(let g of s){let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(u.substring(2).trim()===e){a=!0;continue}a&&(a=!1)}a||l.push(g)}await this.app.vault.modify(i,l.join(`
`));let h=this.app.vault.getAbstractFileByPath(t);if(!(h instanceof S.TFile))return;let p=[...(await this.app.vault.read(h)).split(`
`),...n];await this.app.vault.modify(h,p.join(`
`))}async moveH2ToEndOfH1(o,t,e,i,r){let s=this.app.vault.getAbstractFileByPath(o);if(!(s instanceof S.TFile))return;let a=(await this.app.vault.read(s)).split(`
`),l=[],h=!1,c=!1;for(let f of a){let w=f.trim();if(w.startsWith("# ")&&!w.startsWith("## ")){if(h=w.substring(2).trim()===t,!h&&c)break;h||(c=!1)}else if(h&&w.startsWith("## ")&&!w.startsWith("### ")){if(w.substring(3).trim()===r)c=!0,l.push(f);else if(c)break}else c&&l.push(f)}if(l.length===0||o===e&&t===i)return;await this.removeH2FromFile(o,t,r);let d=this.app.vault.getAbstractFileByPath(e);if(!(d instanceof S.TFile))return;let g=(await this.app.vault.read(d)).split(`
`),u=g.length,v=!1;for(let f=0;f<g.length;f++){let w=g[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")){if(y.substring(2).trim()===i)v=!0;else if(v){u=f;break}}}let m=[...g.slice(0,u),...l,...g.slice(u)];await this.app.vault.modify(d,m.join(`
`))}async moveH2BetweenH1s(o,t,e,i,r,s,n=!1){let a=this.app.vault.getAbstractFileByPath(o);if(!(a instanceof S.TFile))return;let h=(await this.app.vault.read(a)).split(`
`),c=[],d=!1,p=!1;for(let g of h){let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(d=u.substring(2).trim()===t,!d&&p)break}else if(d&&u.startsWith("## ")&&!u.startsWith("### ")){if(u.substring(3).trim()===r)p=!0,c.push(g);else if(p)break}else p&&c.push(g)}c.length!==0&&(await this.removeH2FromFile(o,t,r),await this.insertH2ToFile(e,i,s,c,n))}async removeH2FromFile(o,t,e){let i=this.app.vault.getAbstractFileByPath(o);if(!(i instanceof S.TFile))return;let s=(await this.app.vault.read(i)).split(`
`),n=[],a=!1,l=!1;for(let h of s){let c=h.trim();c.startsWith("# ")&&!c.startsWith("## ")?(a=c.substring(2).trim()===t,l=!1,n.push(h)):a&&c.startsWith("## ")&&!c.startsWith("### ")?c.substring(3).trim()===e?l=!0:(l=!1,n.push(h)):l||n.push(h)}await this.app.vault.modify(i,n.join(`
`))}async insertH2ToFile(o,t,e,i,r=!1){let s=this.app.vault.getAbstractFileByPath(o);if(!(s instanceof S.TFile))return;let a=(await this.app.vault.read(s)).split(`
`),l=a.length,h=!1,c=!1;for(let p=0;p<a.length;p++){let g=a[p];if(!g)continue;let u=g.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(u.substring(2).trim()===t)h=!0;else if(h){l=p;break}}else if(h&&u.startsWith("## ")&&!u.startsWith("### ")&&u.substring(3).trim()===e)if(c=!0,r){l=p;break}else{for(let m=p+1;m<a.length;m++){let f=a[m];if(!f)continue;let w=f.trim();if(w.startsWith("## ")&&!w.startsWith("### ")){l=m;break}else if(w.startsWith("# ")&&!w.startsWith("## ")){l=m;break}}break}}let d=[...a.slice(0,l),...i,...a.slice(l)];await this.app.vault.modify(s,d.join(`
`))}};var M=require("obsidian"),T=require("@codemirror/view"),I=require("@codemirror/state"),V=class{constructor(o){this.keywordsCache=new Map;this.keywordPreviewCache=new Map;this.keywordGroupCache=new Map;this.keywordsVersion=0;this.previewEl=null;this.previewHoverKey="";this.previewAnchorEl=null;this.currentPreviewData=null;this.previewHideTimer=null;this.previewHideDelayMs=450;this.plugin=o,this.app=o.app,this.initializeHoverPreview(),this.plugin.register(()=>this.destroyHoverPreview())}getSettingFolderForFile(o){for(let t of this.plugin.settings.folderMappings)if(t.novelFolder&&t.settingFolder){let e=t.novelFolder.replace(/^\/+|\/+$/g,"");if(o.replace(/^\/+/,"").startsWith(e+"/"))return t.settingFolder}return null}async extractKeywordsFromSettingFolder(o){if(this.keywordsCache.has(o)&&this.keywordPreviewCache.has(o)&&this.keywordGroupCache.has(o))return this.keywordsCache.get(o);let t=new Set,e=new Map,i=new Map;if(!o)return t;let r=this.plugin.parser.getMarkdownFilesInFolder(o),s=await Promise.all(r.map(n=>this.plugin.parser.parseFile(n)));for(let n of s)if(n)for(let a of n.h1List)for(let l of a.h2List){let h=l.text.trim();if(h){let c=this.extractAliases(l.content),d=`h2::${n.filePath}::${a.text}::${l.text}`,p={keyword:h,filePath:n.filePath,fileName:n.fileName,h1Title:a.text,h2Title:l.text,status:this.extractPreferredStatus(l.content),aliases:c,bodyLines:this.extractBodyLines(l.content)};this.addKeywordVariant(t,e,i,h,p,d);for(let u of c)this.addKeywordVariant(t,e,i,u,p,d);let g=this.extractH3Sections(l.content);for(let u of g){if(!u.title)continue;let v=`h3::${n.filePath}::${a.text}::${l.text}::${u.title}`,m={keyword:u.title,filePath:n.filePath,fileName:n.fileName,h1Title:a.text,h2Title:l.text,status:u.status,aliases:u.aliases,bodyLines:u.bodyLines};this.addKeywordVariant(t,e,i,u.title,m,v);for(let f of u.aliases)this.addKeywordVariant(t,e,i,f,m,v)}}}return this.keywordsCache.set(o,t),this.keywordPreviewCache.set(o,e),this.keywordGroupCache.set(o,i),t}clearCache(){this.keywordsCache.clear(),this.keywordPreviewCache.clear(),this.keywordGroupCache.clear(),this.keywordsVersion++}getKeywordsVersion(){return this.keywordsVersion}refreshCurrentEditor(){this.clearCache();let o=this.app.workspace.getLeavesOfType("markdown");for(let t of o){let e=t.view;if(e instanceof M.MarkdownView&&e.editor){e.editor.refresh();let i=e.editor.cm;i&&i.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}}}getMarkdownViewForEditorView(o){let t=this.app.workspace.getLeavesOfType("markdown");for(let e of t){let i=e.view;if(!(i instanceof M.MarkdownView))continue;if(i.editor.cm===o)return i}return null}extractAliases(o){let t=[];for(let e of o){let i="\u3010\u522B\u540D\u3011",r=e.indexOf(i);if(r===-1)continue;let s=e.slice(r+i.length).trim();if(!s)continue;let n=s.split(/[,]/);for(let a of n){let l=a.trim();l&&t.push(l)}}return[...new Set(t)]}extractBodyLines(o){return o.map(t=>t.trim()).filter(t=>t.length>0).filter(t=>!/[^]+/.test(t)).map(t=>t.replace(/^[-*+]\s+/,"").trim()).filter(t=>t.length>0)}extractPreferredStatus(o){let t=[];for(let e of o){let i="\u3010\u72B6\u6001\u3011",r=e.indexOf(i);if(r===-1)continue;let s=e.slice(r+i.length).trim();if(!s)continue;let n=s.replace(/\s+/g," ").trim();n.includes("\u6B7B\u4EA1")&&t.push("\u6B7B\u4EA1"),n.includes("\u5931\u6548")&&t.push("\u5931\u6548");let a=n.split(/[,/|;]+/);for(let l of a){let h=l.trim();h&&t.push(h)}}if(t.length!==0)return t.includes("\u6B7B\u4EA1")?"\u6B7B\u4EA1":t.includes("\u5931\u6548")?"\u5931\u6548":t[0]}getKeywordPreview(o,t){var i;let e=this.keywordPreviewCache.get(o);return e&&(i=e.get(t))!=null?i:null}getKeywordGroupMap(o){var t;return(t=this.keywordGroupCache.get(o))!=null?t:new Map}addKeywordVariant(o,t,e,i,r,s){let n=i.trim();n&&(t.has(n)||(o.add(n),t.set(n,r),e.set(n,s)))}extractH3Sections(o){let t=[],e="",i=[],r=()=>{e&&t.push({title:e,status:this.extractPreferredStatus(i),aliases:this.extractAliases(i),bodyLines:this.extractBodyLines(i)})};for(let s of o){let n=s.trim();if(n.startsWith("### ")&&!n.startsWith("#### ")){r(),e=n.slice(4).trim(),i=[];continue}e&&i.push(s)}return r(),t}initializeHoverPreview(){this.previewEl=document.createElement("div"),this.previewEl.className="chinese-writer-highlight-preview",this.previewEl.style.display="none",document.body.appendChild(this.previewEl),this.plugin.registerDomEvent(this.previewEl,"mouseenter",()=>{this.clearScheduledHidePreview()}),this.plugin.registerDomEvent(this.previewEl,"mouseleave",()=>{this.scheduleHidePreview()}),this.plugin.registerDomEvent(document,"mousemove",o=>{this.handlePreviewHover(o)}),this.plugin.registerDomEvent(document,"mousedown",o=>{var r,s;let t=o.target;if(!t){this.hidePreview();return}let e=(s=(r=this.previewEl)==null?void 0:r.contains(t))!=null?s:!1,i=!!t.closest(".chinese-writer-highlight");!e&&!i&&this.hidePreview()}),this.plugin.registerDomEvent(document,"mouseleave",()=>this.scheduleHidePreview(120))}destroyHoverPreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.remove(),this.previewEl=null)}handlePreviewHover(o){var h,c;let t=o.target;if(!t){this.scheduleHidePreview();return}if((c=(h=this.previewEl)==null?void 0:h.contains(t))!=null?c:!1){this.clearScheduledHidePreview();return}let i=t.closest(".cw-tree-preview-anchor");if(i){if(!this.plugin.settings.enableTreeH2HoverPreview){this.scheduleHidePreview(80);return}this.clearScheduledHidePreview(),this.showPreviewForTreeNodeAnchor(i,o.clientX,o.clientY);return}let r=t.closest(".chinese-writer-highlight");if(!r){this.scheduleHidePreview();return}if(!this.plugin.settings.enableEditorHoverPreview){this.scheduleHidePreview(80);return}let s=r.dataset.cwKeyword,n=r.dataset.cwSettingFolder;if(!s||!n){this.scheduleHidePreview();return}let a=this.getKeywordPreview(n,s);if(!a){this.scheduleHidePreview();return}this.clearScheduledHidePreview();let l=`${n}::${s}`;this.showPreview(a,l,r,o.clientX,o.clientY)}async showPreviewForTreeNodeAnchor(o,t,e){var c;let i=o.dataset.cwTreeSettingFolder,r=o.dataset.cwTreeFilePath,s=o.dataset.cwTreeH1,n=o.dataset.cwTreeH2,a=(c=o.dataset.cwTreeKeyword)!=null?c:n;if(!i||!r||!s||!n||!a){this.scheduleHidePreview(120);return}await this.extractKeywordsFromSettingFolder(i);let l=this.findTreeNodePreviewData(i,r,s,n,a);if(!l){this.scheduleHidePreview(120);return}this.clearScheduledHidePreview();let h=`tree::${r}::${s}::${n}`;this.showPreview(l,h,o,t,e)}findTreeNodePreviewData(o,t,e,i,r){var n;let s=this.keywordPreviewCache.get(o);if(!s)return null;for(let a of s.values())if(a.filePath===t&&a.h1Title===e&&a.h2Title===i)return a;return(n=s.get(r))!=null?n:null}showPreview(o,t,e,i,r){if(!this.previewEl)return;let s=this.previewHoverKey!==t,n=this.previewAnchorEl!==e;if(s){this.previewEl.empty();let l=this.previewEl.createDiv({cls:"cw-preview-header"}),h=l.createDiv({cls:"cw-preview-header-main"}),c=h.createDiv({cls:"cw-preview-title"}),d=o.status?`${o.keyword}[${o.status}]`:o.keyword;c.setText(d),h.createDiv({cls:"cw-preview-location"}).setText(`${o.fileName}/${o.h1Title}`);let g=l.createDiv({cls:"cw-preview-actions"}),u=g.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u641C\u7D22",title:"\u641C\u7D22"}});(0,M.setIcon)(u,"search"),u.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openGlobalSearch(o.keyword)});let v=g.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u7F16\u8F91",title:"\u7F16\u8F91"}});(0,M.setIcon)(v,"pen"),v.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openKeywordSource(o)}),o.aliases.length>0&&(this.previewEl.createDiv({cls:"cw-preview-blank-line"}).setText(" "),this.previewEl.createDiv({cls:"cw-preview-label"}).setText("\u522B\u540D"),this.previewEl.createDiv({cls:"cw-preview-aliases"}).setText(o.aliases.join(" "))),this.previewEl.createDiv({cls:"cw-preview-divider"});let m=this.previewEl.createDiv({cls:"cw-preview-body"});if(o.bodyLines.length===0)m.createDiv({cls:"cw-preview-empty",text:"\uFF08\u65E0\u8BBE\u5B9A\u5185\u5BB9\uFF09"});else{let f=m.createEl("ul",{cls:"cw-preview-list"});for(let w of o.bodyLines)f.createEl("li",{cls:"cw-preview-line"}).setText(w)}this.previewHoverKey=t,this.previewAnchorEl=e,this.currentPreviewData=o}let a=this.plugin.settings.highlightPreviewStyle;if(this.previewEl.style.width=`${a.width}px`,this.previewEl.style.maxHeight=`${a.height}px`,this.previewEl.style.setProperty("--cw-preview-max-lines",String(a.maxBodyLines)),this.previewEl.style.display="flex",this.applyBodyMaxHeight(a.height,a.maxBodyLines),s||n){this.previewAnchorEl=e;let l=14,h=i+l,c=r+l,d=this.previewEl.getBoundingClientRect();h+d.width>window.innerWidth-8&&(h=Math.max(8,i-d.width-l)),c+d.height>window.innerHeight-8&&(c=Math.max(8,r-d.height-l)),this.previewEl.style.left=`${h}px`,this.previewEl.style.top=`${c}px`}}hidePreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.style.display="none",this.previewHoverKey="",this.previewAnchorEl=null,this.currentPreviewData=null)}scheduleHidePreview(o=this.previewHideDelayMs){this.clearScheduledHidePreview(),this.previewHideTimer=window.setTimeout(()=>{this.hidePreview()},o)}clearScheduledHidePreview(){this.previewHideTimer!==null&&(window.clearTimeout(this.previewHideTimer),this.previewHideTimer=null)}applyBodyMaxHeight(o,t){if(!this.previewEl)return;let e=this.previewEl.querySelector(".cw-preview-body");if(!e)return;let r=Math.max(40,t*21),s=Math.max(0,this.previewEl.offsetHeight-e.offsetHeight),n=Math.max(40,o-s-4),a=Math.min(r,n);e.style.maxHeight=`${a}px`}async openGlobalSearch(o){let t=o.trim();if(!t)return;let e=this.app.commands;e&&await e.executeCommandById("global-search:open"),window.setTimeout(()=>{var a;let i=this.app.workspace.getLeavesOfType("search");if(i.length===0)return;let r=(a=i[0])==null?void 0:a.view,s=r==null?void 0:r.containerEl;if(!s)return;let n=s.querySelector("input");n&&(n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),n.focus())},80)}async openKeywordSource(o){let t=this.app.vault.getAbstractFileByPath(o.filePath);if(!(t instanceof M.TFile))return;let i=(await this.app.vault.read(t)).split(`
`),r=this.findFirstContentLine(i,o.h1Title,o.h2Title),s=await this.plugin.openFileWithSettings(t,{revealWhenNewTab:!0});if(!s)return;let n=s.view instanceof M.MarkdownView?s.view:null;n!=null&&n.editor&&(n.editor.setCursor({line:r,ch:0}),this.centerEditorLine(n.editor,r),this.hidePreview())}centerEditorLine(o,t){let e=o.cm;if(!e)return;let i=Math.max(0,Math.min(t,e.state.doc.lines-1)),r=e.state.doc.line(i+1).from,s=()=>{e.dispatch({effects:T.EditorView.scrollIntoView(r,{y:"center",yMargin:0})})};s(),window.setTimeout(s,30)}findFirstContentLine(o,t,e){var n,a;let i=!1,r=!1,s=0;for(let l=0;l<o.length;l++){let h=(a=(n=o[l])==null?void 0:n.trim())!=null?a:"";if(h.startsWith("# ")&&!h.startsWith("## ")){i=h.slice(2).trim()===t,r=!1;continue}if(i&&h.startsWith("## ")&&!h.startsWith("### ")){r=h.slice(3).trim()===e,r&&(s=l);continue}if(r){if(h.startsWith("#"))break;if(h.length>0)return l}}return s}isFileInFolder(o,t){let e=t.replace(/^\/+|\/+$/g,""),i=o.replace(/^\/+/,"");return e?i.startsWith(e+"/"):!1}collectPunctuationWarnings(o){var i,r;let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return[];let e=new Set;for(let s=0;s<o.length;s++){let n=o[s];if(t.comma&&n===","&&e.add(s),t.period&&n==="."){let a=s>0&&(i=o[s-1])!=null?i:"",l=s+1<o.length&&(r=o[s+1])!=null?r:"";/\d/.test(a)&&/\d/.test(l)||e.add(s)}t.colon&&n===":"&&e.add(s),t.semicolon&&n===";"&&e.add(s),t.exclamation&&n==="!"&&e.add(s),t.question&&n==="?"&&e.add(s),t.doubleQuote&&n==='"'&&e.add(s),t.singleQuote&&n==="'"&&e.add(s)}if(t.doubleQuote){let s=[];for(let n=0;n<o.length;n++){let a=o[n];a==="\u201C"?s.push(n):a==="\u201D"&&(s.length>0?s.pop():e.add(n))}for(let n of s)e.add(n)}if(t.singleQuote){let s=[];for(let n=0;n<o.length;n++){let a=o[n];a==="\u2018"?s.push(n):a==="\u2019"&&(s.length>0?s.pop():e.add(n))}for(let n of s)e.add(n)}return Array.from(e).sort((s,n)=>s-n)}async fixPunctuationForActiveEditor(){let o=this.app.workspace.getActiveViewOfType(M.MarkdownView);if(!(o!=null&&o.file)||!o.editor)return;let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return;let e=this.getSettingFolderForFile(o.file.path);if(!e||this.isFileInFolder(o.file.path,e))return;let i=o.editor.getValue(),{text:r,changedCount:s}=this.applyPunctuationFixes(i);s<=0||r===i||(o.editor.setValue(r),this.refreshCurrentEditor())}applyPunctuationFixes(o){let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return{text:o,changedCount:0};let e=o,i=0,r=(s,n,a)=>{var c;let l=0,h=s.split("");for(let d=0;d<h.length;d++){let p=(c=h[d])!=null?c:"";n(p,d,s)&&p!==a&&(h[d]=a,l++)}return{text:h.join(""),count:l}};if(t.comma){let s=r(e,n=>n===",","\uFF0C");e=s.text,i+=s.count}if(t.period){let s=r(e,(n,a,l)=>{var p,g;if(n!==".")return!1;let h=a>0&&(p=l[a-1])!=null?p:"",c=a+1<l.length&&(g=l[a+1])!=null?g:"";return!(/\d/.test(h)&&/\d/.test(c))},"\u3002");e=s.text,i+=s.count}if(t.semicolon){let s=r(e,n=>n===";","\uFF1B");e=s.text,i+=s.count}if(t.exclamation){let s=r(e,n=>n==="!","\uFF01");e=s.text,i+=s.count}if(t.question){let s=r(e,n=>n==="?","\uFF1F");e=s.text,i+=s.count}if(t.colon){let s=r(e,n=>n===":","\uFF1A");e=s.text,i+=s.count}if(t.doubleQuote){let s=this.normalizeQuotePairs(e,new Set(['"',"\u201C","\u201D"]),"\u201C","\u201D");e=s.text,i+=s.count}if(t.singleQuote){let s=this.normalizeQuotePairs(e,new Set(["'","\u2018","\u2019"]),"\u2018","\u2019");e=s.text,i+=s.count}return{text:e,changedCount:i}}normalizeQuotePairs(o,t,e,i){var a;let r=!0,s=0,n=o.split("");for(let l=0;l<n.length;l++){let h=(a=n[l])!=null?a:"";if(!t.has(h))continue;let c=r?e:i;h!==c&&(n[l]=c,s++),r=!r}return{text:n.join(""),count:s}}createEditorExtension(){let o=this;return T.ViewPlugin.fromClass(class{constructor(t){this.decorations=T.Decoration.none;this.currentFile=null;this.keywordsVersionSeen=-1;this.updateRunId=0;this.keywordsVersionSeen=o.getKeywordsVersion(),this.updateDecorations(t)}async updateDecorations(t){let e=++this.updateRunId,i=o.getMarkdownViewForEditorView(t);if(!i||!i.file){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}let r=i.file;this.currentFile=r,this.keywordsVersionSeen=o.getKeywordsVersion();let s=o.getSettingFolderForFile(r.path);if(!s){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}if(o.isFileInFolder(r.path,s)){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}let n=await o.extractKeywordsFromSettingFolder(s);if(e!==this.updateRunId)return;let a=new I.RangeSetBuilder,h=t.state.doc.toString(),c=[],d=o.getKeywordGroupMap(s),p=o.plugin.settings.highlightStyle.mode;for(let m of n){let f=m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),w=new RegExp(f,"g"),y;for(;(y=w.exec(h))!==null;)c.push({from:y.index,to:y.index+m.length,keyword:m})}let g=p==="first"?(()=>{var w;let m=new Map,f=[...c].sort((y,H)=>y.from-H.from);for(let y of f){let H=(w=d.get(y.keyword))!=null?w:`kw::${y.keyword}`;m.has(H)||m.set(H,y)}return Array.from(m.values())})():c,u=[];g.sort((m,f)=>m.from-f.from);for(let m of g)u.push({from:m.from,to:m.to,decoration:T.Decoration.mark({class:"chinese-writer-highlight",attributes:{"data-cw-keyword":m.keyword,"data-cw-setting-folder":s}})});let v=o.collectPunctuationWarnings(h);for(let m of v)u.push({from:m,to:m+1,decoration:T.Decoration.mark({class:"chinese-writer-punctuation-warning"})});u.sort((m,f)=>m.from!==f.from?m.from-f.from:m.to-f.to);for(let m of u)a.add(m.from,m.to,m.decoration);this.decorations=a.finish(),t.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}update(t){var a,l,h,c;let e=this.keywordsVersionSeen!==o.getKeywordsVersion(),i=o.getMarkdownViewForEditorView(t.view),r=(l=(a=i==null?void 0:i.file)==null?void 0:a.path)!=null?l:null,s=(c=(h=this.currentFile)==null?void 0:h.path)!=null?c:null,n=r!==s;(t.docChanged||e||n)&&this.updateDecorations(t.view)}destroy(){}},{decorations:t=>t.decorations})}updateStyles(){let o=this.plugin.settings.highlightStyle,t=o.borderWidth>0?"underline":"none",e=document.getElementById("chinese-writer-highlight-style");e&&e.remove();let i=document.createElement("style");i.id="chinese-writer-highlight-style",i.textContent=`
      .chinese-writer-highlight {
        background-color: ${o.backgroundColor};
        text-decoration-line: ${t} !important;
        text-decoration-style: ${o.borderStyle} !important;
        text-decoration-color: ${o.borderColor} !important;
        text-decoration-thickness: ${o.borderWidth}px !important;
        text-underline-offset: 8px !important;
        text-decoration-skip-ink: none !important;
        font-weight: ${o.fontWeight};
        font-style: ${o.fontStyle};
        color: ${o.color};
      }
    `,document.head.appendChild(i)}};var $=class{constructor(o){this.plugin=o}updateStyles(){var s,n,a;let o=Math.max(0,(s=this.plugin.settings.editorIndentCjkChars)!=null?s:0),t=Math.max(1,(n=this.plugin.settings.editorLineHeight)!=null?n:1.8),e=Math.max(0,(a=this.plugin.settings.editorParagraphSpacing)!=null?a:0),i=document.getElementById("chinese-writer-editor-typography-style");i&&i.remove();let r=document.createElement("style");r.id="chinese-writer-editor-typography-style",r.textContent=`
      .markdown-source-view.mod-cm6 .cm-line {
        line-height: ${t};
      }

      .markdown-source-view.mod-cm6 .cm-line:not(.HyperMD-codeblock):not(.HyperMD-header):not(.HyperMD-list-line):not(.HyperMD-quote) {
        text-indent: calc(${o} * 1em);
        padding-top: calc(${e}px / 2);
        padding-bottom: calc(${e}px / 2);
        box-sizing: border-box;
      }
    `,document.head.appendChild(r)}};var R=class extends F.Plugin{constructor(){super(...arguments);this.pluginDir="";this.settingsFilePath="";this.settingMenuRootEl=null;this.settingMenuChildEl=null;this.settingMenuCloseTimer=null;this.settingMenuExpandDirection="right";this.h3TitleCacheByFolder=new Map}async onload(){this.pluginDir=await this.resolvePluginDir(),this.settingsFilePath=`${this.pluginDir}/cw-setting.json`,await this.loadSettings(),this.parser=new A(this.app.vault),this.orderManager=new B(this.app,this.pluginDir),await this.orderManager.load(),await this.rebuildAllH3TitleCache(),this.highlightManager=new V(this),this.editorTypographyManager=new $(this),this.registerEditorExtension(this.highlightManager.createEditorExtension()),this.highlightManager.updateStyles(),this.editorTypographyManager.updateStyles(),this.registerView(C,t=>new L(t,this)),this.addCommand({id:"open-tree-view",name:"\u6253\u5F00\u6587\u6863\u6811\u89C6\u56FE",callback:()=>{this.activateView()}}),this.addCommand({id:"auto-fix-punctuation-in-current-file",name:"\u81EA\u52A8\u4FEE\u6B63\u5F53\u524D\u6587\u6863\u6807\u70B9\u95EE\u9898",callback:async()=>{await this.highlightManager.fixPunctuationForActiveEditor()}}),this.addRibbonIcon("book-type","\u4E2D\u6587\u5199\u4F5C",()=>{this.activateView()}),this.addSettingTab(new W(this.app,this)),this.register(()=>this.closeSettingSubmenus()),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{this.appendAddSettingEditorMenu(t,e,i)})),this.app.workspace.onLayoutReady(()=>{setTimeout(()=>{let t=this.app.workspace.getActiveViewOfType(F.MarkdownView);t&&t.file&&this.highlightManager.refreshCurrentEditor()},100)}),this.registerEvent(this.app.vault.on("modify",t=>{if(t instanceof F.TFile&&t.extension==="md"){this.smartUpdateView(),this.updateH3CacheForSettingFile(t.path);for(let e of this.settings.folderMappings)if(e.settingFolder&&t.path.startsWith(e.settingFolder+"/")){this.highlightManager.clearCache(),setTimeout(()=>{this.highlightManager.refreshCurrentEditor()},100);break}}})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileCreate(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileDelete(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof F.TFile&&t.extension==="md"&&(this.syncOrderOnFileRename(t,e),this.updateH3CacheForSettingFile(e),this.updateH3CacheForSettingFile(t.path))})),this.app.workspace.onLayoutReady(()=>{this.activateView()})}onunload(){this.app.workspace.detachLeavesOfType(C)}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(C)[0];if(!e){let i=t.getRightLeaf(!1);i&&(await i.setViewState({type:C,active:!0}),e=i)}e&&t.revealLeaf(e)}async refreshView(){let t=this.app.workspace.getLeavesOfType(C);for(let e of t){let i=e.view;i instanceof L&&await i.refresh()}}async smartUpdateView(){let t=this.app.workspace.getLeavesOfType(C);for(let e of t){let i=e.view;i instanceof L&&await i.smartUpdate()}}async loadSettings(){let t=await this.readSettingsData();this.settings=Object.assign({},D,t),this.settings.highlightStyle&&(this.settings.highlightStyle=Object.assign({},D.highlightStyle,this.settings.highlightStyle)),this.settings.highlightPreviewStyle?this.settings.highlightPreviewStyle=Object.assign({},D.highlightPreviewStyle,this.settings.highlightPreviewStyle):this.settings.highlightPreviewStyle=Object.assign({},D.highlightPreviewStyle),this.settings.punctuationCheck?this.settings.punctuationCheck=Object.assign({},D.punctuationCheck,this.settings.punctuationCheck):this.settings.punctuationCheck=Object.assign({},D.punctuationCheck);let e=t==null?void 0:t.openInCurrentTab;!(typeof(t==null?void 0:t.openInNewTab)=="boolean")&&typeof e=="boolean"&&(this.settings.openInNewTab=!e),t&&t.targetFolder&&this.settings.folderMappings.length===0&&console.log("\u68C0\u6D4B\u5230\u65E7\u7248\u672C\u914D\u7F6E\uFF0C\u5DF2\u5220\u9664 targetFolder \u5B57\u6BB5\u3002\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u65B0\u7684\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB\u3002")}async saveSettings(){let t=this.app.vault.adapter,e=this.settingsFilePath.substring(0,this.settingsFilePath.lastIndexOf("/"));e&&!await t.exists(e)&&await t.mkdir(e),await t.write(this.settingsFilePath,JSON.stringify(this.settings,null,2))}async resolvePluginDir(){var n,a,l;let t=this.app.vault.adapter,e=(n=this.manifest.dir)==null?void 0:n.trim(),i=(l=(a=this.manifest.id)==null?void 0:a.trim())!=null?l:"",r=i.toLowerCase(),s=Array.from(new Set([e,i?`.obsidian/plugins/${i}`:null,r?`.obsidian/plugins/${r}`:null].filter(h=>!!h&&h.length>0)));for(let h of s)if(await t.exists(`${h}/cw-setting.json`)||await t.exists(`${h}/cw-view-datas.json`)||await t.exists(`${h}/settings.json`)||await t.exists(`${h}/data.json`)||await t.exists(`${h}/view-datas.json`)||await t.exists(`${h}/order.json`))return h;for(let h of s)if(await t.exists(h))return h;return e&&e.length>0?e:`.obsidian/plugins/${r||"chinese-writer"}`}async readSettingsData(){let t=this.app.vault.adapter,e=`${this.pluginDir}/cw-setting.json`,i=`${this.pluginDir}/settings.json`,r=`${this.pluginDir}/data.json`;try{if(await t.exists(e)){let s=await t.read(e),n=JSON.parse(s);return n&&typeof n=="object"?n:{}}if(await t.exists(i)){let s=await t.read(i),n=JSON.parse(s);return n&&typeof n=="object"?n:{}}if(await t.exists(r)){let s=await t.read(r),n=JSON.parse(s);return n&&typeof n=="object"?n:{}}}catch(s){console.error("Failed to read settings data:",s)}return{}}async openFileWithSettings(t,e){var a;let i=this.settings.openInNewTab,r=(a=e==null?void 0:e.revealWhenNewTab)!=null?a:!1,s=this.findOpenedLeafForFile(t.path);if(s)return(!i||r)&&this.app.workspace.revealLeaf(s),s;if(!i){let l=this.getPreferredCurrentLeaf();return l?(await l.openFile(t,{active:!0}),l):null}let n=this.app.workspace.getLeaf("tab");return await n.openFile(t,{active:r}),n}getPreferredCurrentLeaf(){let t=this.app.workspace.getActiveViewOfType(F.MarkdownView);if(t)return t.leaf;let e=this.app.workspace.getLeavesOfType("markdown");return e.length>0?e[0]:this.app.workspace.getMostRecentLeaf()}findOpenedLeafForFile(t){var i,r;let e=this.app.workspace.getLeavesOfType("markdown");for(let s of e){let n=s.getViewState();if((typeof((i=n.state)==null?void 0:i.file)=="string"?n.state.file:null)===t)return s;let l=s.view;if(l instanceof F.MarkdownView&&((r=l.file)==null?void 0:r.path)===t)return s}return null}appendAddSettingEditorMenu(t,e,i){var l;let s=e.getSelection().replace(/\s+/g," ").trim();if(!s)return;let n=(l=i==null?void 0:i.file)!=null?l:this.app.workspace.getActiveFile();if(!(n instanceof F.TFile))return;let a=this.highlightManager.getSettingFolderForFile(n.path);a&&(this.hasH3InSettingFolder(a,s)||(t.addSeparator(),t.addItem(h=>{h.setTitle("\u6DFB\u52A0\u8BBE\u5B9A"),h.setIcon("book-plus"),h.onClick(d=>{this.openSettingFirstLevelMenu(d.clientX,d.clientY,a,s,null)});let c=h==null?void 0:h.dom;if(c){let d=c.createSpan({cls:"cw-context-submenu-arrow"});(0,F.setIcon)(d,"chevron-right"),c.addEventListener("mouseenter",()=>{let p=c.getBoundingClientRect();this.openSettingFirstLevelMenu(p.right-2,p.top,a,s,p)}),c.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}})))}async collectSettingFileOptions(t){let e=this.parser.getMarkdownFilesInFolder(t),i=this.orderManager.getFileOrder(),r=[...e].sort((n,a)=>{let l=i.indexOf(n.path),h=i.indexOf(a.path);return l===-1&&h===-1?n.path.localeCompare(a.path):l===-1?1:h===-1?-1:l-h}),s=[];for(let n of r){let a=await this.parser.parseFile(n);if(!a)continue;let l=[];for(let h of a.h1List)l.push({label:h.text,lineNumber:h.lineNumber});s.push({file:n,h1Options:l})}return s}async openSettingFirstLevelMenu(t,e,i,r,s){this.clearCloseSettingSubmenusTimer();let n=await this.collectSettingFileOptions(i);if(n.length===0){this.closeSettingSubmenus(),new F.Notice("\u8BE5\u8BBE\u5B9A\u5E93\u6CA1\u6709\u53EF\u7528\u7684 H1 \u9009\u9879");return}this.settingMenuRootEl||(this.settingMenuRootEl=this.createSettingSubmenuContainer("cw-setting-submenu-root")),this.settingMenuRootEl.empty(),this.settingMenuRootEl.removeClass("is-expand-left"),this.settingMenuRootEl.removeClass("is-expand-right");let a=[];for(let c of n){let d=this.settingMenuRootEl.createDiv({cls:"cw-setting-submenu-item"}),p=d.createSpan({cls:"cw-setting-submenu-item-icon"});(0,F.setIcon)(p,"file-text"),d.createSpan({text:c.file.basename,cls:"cw-setting-submenu-label"});let g=c.h1Options.length>0,u=d.createSpan({cls:"cw-setting-submenu-item-arrow"});(0,F.setIcon)(u,"chevron-right"),a.push({el:u,hasChildren:g}),g||d.addClass("is-disabled"),d.addEventListener("mouseenter",()=>{if(this.clearCloseSettingSubmenusTimer(),g){let v=d.getBoundingClientRect();this.openSettingSecondLevelMenu(v,c,r)}else this.closeSettingChildMenu()}),d.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}let l=s!=null?s:this.createPointAnchorRect(t,e);this.settingMenuExpandDirection=this.pickMenuExpandDirection(this.settingMenuRootEl,l);let h=this.settingMenuExpandDirection==="left";this.settingMenuRootEl.toggleClass("is-expand-left",h),this.settingMenuRootEl.toggleClass("is-expand-right",!h);for(let c of a)c.hasChildren&&(c.el.empty(),(0,F.setIcon)(c.el,h?"chevron-left":"chevron-right"));s?this.placeMenuBesideAnchor(this.settingMenuRootEl,s,2,this.settingMenuExpandDirection):this.placeMenuBesideAnchor(this.settingMenuRootEl,l,2,this.settingMenuExpandDirection),this.settingMenuRootEl.style.display="block"}openSettingSecondLevelMenu(t,e,i){this.clearCloseSettingSubmenusTimer(),this.settingMenuChildEl||(this.settingMenuChildEl=this.createSettingSubmenuContainer("cw-setting-submenu-child")),this.settingMenuChildEl.empty();for(let r of e.h1Options){let s=this.settingMenuChildEl.createDiv({cls:"cw-setting-submenu-item"}),n=s.createSpan({cls:"cw-setting-submenu-item-icon"});(0,F.setIcon)(n,"heading-1"),s.createSpan({text:r.label,cls:"cw-setting-submenu-label"}),s.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),s.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),s.addEventListener("click",()=>{this.appendSelectionAsH2(e.file,r.lineNumber,i)})}this.placeMenuBesideAnchor(this.settingMenuChildEl,t,2,this.settingMenuExpandDirection),this.settingMenuChildEl.style.display="block"}async appendSelectionAsH2(t,e,i){var h,c;let r=i.replace(/\s+/g," ").trim();if(!r)return;let n=(await this.app.vault.read(t)).split(`
`),a=Math.max(0,Math.min(e,n.length-1)),l=n.length;for(let d=a+1;d<n.length;d++){let p=(c=(h=n[d])==null?void 0:h.trim())!=null?c:"";if(p.startsWith("# ")&&!p.startsWith("## ")){l=d;break}}n.splice(l,0,`## ${r}`),await this.app.vault.modify(t,n.join(`
`)),this.updateH3CacheForSettingFile(t.path),this.highlightManager.clearCache(),await this.smartUpdateView(),new F.Notice(`\u5DF2\u6DFB\u52A0\u5230\uFF1A${t.basename}`),this.closeSettingSubmenus()}placeMenuWithinViewport(t,e,i){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let r=t.getBoundingClientRect(),s=8,n=Math.min(Math.max(s,e),Math.max(s,window.innerWidth-r.width-s)),a=Math.min(Math.max(s,i),Math.max(s,window.innerHeight-r.height-s));t.style.left=`${n}px`,t.style.top=`${a}px`,t.style.visibility="visible"}placeMenuBesideAnchor(t,e,i,r){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let s=t.getBoundingClientRect(),n=8,a=r==="right"?e.right+i:e.left-s.width-i;(a+s.width>window.innerWidth-n||a<n)&&(a=r==="right"?e.left-s.width-i:e.right+i),(a+s.width>window.innerWidth-n||a<n)&&(a=e.left-s.width-i),a=Math.min(Math.max(n,a),Math.max(n,window.innerWidth-s.width-n));let l=e.top;l+s.height>window.innerHeight-n&&(l=window.innerHeight-s.height-n),l=Math.max(n,l),t.style.left=`${a}px`,t.style.top=`${l}px`,t.style.visibility="visible"}pickMenuExpandDirection(t,e){let r=this.measureMenuWidth(t),s=this.measureMenuClassWidth("cw-setting-submenu cw-setting-submenu-child"),n=r+2+s,a=window.innerWidth-e.right-8,l=e.left-8,h=a>=n,c=l>=n;return h&&c||h?"right":c?"left":a>=l?"right":"left"}measureMenuWidth(t){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let e=t.getBoundingClientRect().width;return t.style.display="none",t.style.visibility="visible",e}measureMenuClassWidth(t){let e=document.body.createDiv({cls:t});e.style.visibility="hidden",e.style.display="block",e.style.left="0px",e.style.top="0px";let i=e.getBoundingClientRect().width;return e.remove(),i}createPointAnchorRect(t,e){return new DOMRect(t,e,0,0)}createSettingSubmenuContainer(t){let e=document.body.createDiv({cls:`cw-setting-submenu ${t}`});return e.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),e.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),e}closeSettingChildMenu(){this.settingMenuChildEl&&(this.settingMenuChildEl.style.display="none",this.settingMenuChildEl.empty())}closeSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuRootEl&&(this.settingMenuRootEl.remove(),this.settingMenuRootEl=null),this.settingMenuChildEl&&(this.settingMenuChildEl.remove(),this.settingMenuChildEl=null)}scheduleCloseSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuCloseTimer=window.setTimeout(()=>this.closeSettingSubmenus(),180)}clearCloseSettingSubmenusTimer(){this.settingMenuCloseTimer!==null&&(window.clearTimeout(this.settingMenuCloseTimer),this.settingMenuCloseTimer=null)}async rebuildAllH3TitleCache(){this.h3TitleCacheByFolder.clear();let t=this.settings.folderMappings.map(e=>e.settingFolder).filter(e=>!!e);await Promise.all(t.map(e=>this.rebuildH3TitleCacheForFolder(e)))}async rebuildH3TitleCacheForFolder(t){let e=new Set,i=this.parser.getMarkdownFilesInFolder(t),r=await Promise.all(i.map(s=>this.app.vault.read(s)));for(let s of r){let n=s.split(`
`);for(let a of n){let l=a.trim(),h=l.startsWith("## ")&&!l.startsWith("### "),c=l.startsWith("### ")&&!l.startsWith("#### ");if(h||c){let d=h?3:4,p=l.slice(d).replace(/\s+/g," ").trim();p&&e.add(p)}}}this.h3TitleCacheByFolder.set(t,e)}hasH3InSettingFolder(t,e){let i=this.h3TitleCacheByFolder.get(t);if(!i)return!1;let r=e.replace(/\s+/g," ").trim();return i.has(r)}updateH3CacheForSettingFile(t){let e=this.findSettingFolderByFilePath(t);e&&this.rebuildH3TitleCacheForFolder(e)}findSettingFolderByFilePath(t){for(let e of this.settings.folderMappings)if(e.settingFolder&&t.startsWith(`${e.settingFolder}/`))return e.settingFolder;return null}async syncOrderOnFileCreate(t){let e=null;for(let r of this.settings.folderMappings)if(r.settingFolder&&t.path.startsWith(r.settingFolder+"/")){e=r.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0?i=this.parser.getMarkdownFilesInFolder(e).map(s=>s.path):i.includes(t.path)||i.push(t.path),await this.orderManager.setFileOrder(i),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileDelete(t){let e=null;for(let s of this.settings.folderMappings)if(s.settingFolder&&t.path.startsWith(s.settingFolder+"/")){e=s.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0&&(i=this.parser.getMarkdownFilesInFolder(e).map(n=>n.path));let r=i.indexOf(t.path);r!==-1&&(i.splice(r,1),await this.orderManager.setFileOrder(i)),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileRename(t,e){let i=null,r=!1,s=!1;for(let a of this.settings.folderMappings)a.settingFolder&&(e.startsWith(a.settingFolder+"/")&&(r=!0,i=a.settingFolder),t.path.startsWith(a.settingFolder+"/")&&(s=!0,i=a.settingFolder));if(!r&&!s){await this.smartUpdateView();return}if(!i){await this.smartUpdateView();return}let n=this.orderManager.getFileOrder();if(n.length===0)n=this.parser.getMarkdownFilesInFolder(i).map(l=>l.path);else{let a=n.indexOf(e);a!==-1?s?n[a]=t.path:n.splice(a,1):s&&n.push(t.path)}await this.orderManager.setFileOrder(n),setTimeout(()=>{this.smartUpdateView()},400)}};
