/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var U=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var et=Object.prototype.hasOwnProperty;var it=(x,a)=>()=>(x&&(a=x(x=0)),a);var J=(x,a)=>{for(var t in a)U(x,t,{get:a[t],enumerable:!0})},st=(x,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of tt(a))!et.call(x,i)&&i!==t&&U(x,i,{get:()=>a[i],enumerable:!(e=Z(a,i))||e.enumerable});return x};var nt=x=>st(U({},"__esModule",{value:!0}),x);var q={};J(q,{ConfirmModal:()=>k,TextInputModal:()=>P});var z,P,k,O=it(()=>{z=require("obsidian"),P=class extends z.Modal{constructor(t,e,i,r,n){super(t);this.submitted=!1;this.title=e,this.placeholder=i,this.defaultValue=r,this.onSubmit=n}onOpen(){let{contentEl:t}=this,e=t.closest(".modal");e&&(e.style.minHeight="auto",e.style.height="auto",e.style.maxWidth="400px",e.style.width="90%"),t.style.padding="1em";let i=t.createEl("h2",{text:this.title});i.style.marginTop="0",i.style.marginBottom="0.8em",i.style.fontSize="1.2em";let r=t.createEl("input",{type:"text",placeholder:this.placeholder,value:this.defaultValue});r.style.width="100%",r.style.marginBottom="1em",r.style.padding="0.5em",r.focus(),r.select();let n=t.createDiv();n.style.display="flex",n.style.justifyContent="flex-end",n.style.gap="0.5em",n.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()});let o=n.createEl("button",{text:"\u786E\u5B9A",cls:"mod-cta"}),l=()=>{if(this.submitted)return;this.submitted=!0;let h=r.value;this.close(),setTimeout(()=>{this.onSubmit(h)},10)};o.addEventListener("click",l),r.addEventListener("keydown",h=>{h.key==="Enter"?l():h.key==="Escape"&&this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},k=class extends z.Modal{constructor(a,t,e,i){super(a),this.title=t,this.message=e,this.onConfirm=i}onOpen(){let{contentEl:a}=this,t=a.closest(".modal");t&&(t.style.minHeight="auto",t.style.height="auto",t.style.maxWidth="400px",t.style.width="90%"),a.style.padding="1em";let e=a.createEl("h2",{text:this.title});e.style.marginTop="0",e.style.marginBottom="0.8em",e.style.fontSize="1.2em";let i=a.createEl("p",{text:this.message});i.style.marginBottom="1em";let r=a.createDiv();r.style.display="flex",r.style.justifyContent="flex-end",r.style.gap="0.5em",r.style.marginTop="0.5em",r.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u786E\u5B9A",cls:"mod-warning"}).addEventListener("click",()=>{this.close(),this.onConfirm()})}onClose(){let{contentEl:a}=this;a.empty()}}});var rt={};J(rt,{default:()=>K});module.exports=nt(rt);var S=require("obsidian");var b=require("obsidian"),L={folderMappings:[],highlightStyle:{mode:"all",backgroundColor:"#FFFFFF00",borderStyle:"dotted",borderWidth:2,borderColor:"#4A86E9",fontWeight:"normal",fontStyle:"normal",color:"#4A86E9"},highlightPreviewStyle:{width:300,height:340,maxBodyLines:12},punctuationCheck:{enabled:!1,comma:!0,period:!0,colon:!0,semicolon:!0,exclamation:!0,question:!0,doubleQuote:!0,singleQuote:!0},editorIndentCjkChars:2,editorLineHeight:1.6,editorParagraphSpacing:12,enableEditorTypography:!1,enableEditorHoverPreview:!0,enableTreeH2HoverPreview:!1,openInNewTab:!0,enableMdStats:!1},W=class extends b.PluginSettingTab{constructor(t,e){super(t,e);this.isAddingMapping=!1;this.plugin=e}display(){let{containerEl:t}=this,e=async()=>{await this.plugin.saveSettings(),this.refreshEditorHighlight()},i=[],r=s=>{for(let o of i)o.setDisabled(s)};t.empty(),t.createEl("h2",{text:"\u4E2D\u6587\u5199\u4F5C\u63D2\u4EF6\u8BBE\u7F6E",cls:"cw-settings-main-title"}),t.createEl("h3",{text:"\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB"}),t.createEl("p",{text:"\u914D\u7F6E\u5C0F\u8BF4\u5E93\u548C\u8BBE\u5B9A\u5E93\u7684\u5BF9\u5E94\u5173\u7CFB\u3002\u5728\u5C0F\u8BF4\u5E93\u6587\u4EF6\u6253\u5F00\u65F6\uFF0C\u4F1A\u663E\u793A\u5BF9\u5E94\u8BBE\u5B9A\u5E93\u7684\u5185\u5BB9\uFF0C\u5E76\u9AD8\u4EAE\u5173\u952E\u5B57\u3002",cls:"setting-item-description"});let n=t.createDiv({cls:"folder-mappings-container"});this.renderMappings(n),new b.Setting(t).setName("\u6DFB\u52A0\u65B0\u5BF9\u5E94\u5173\u7CFB").addButton(s=>s.setButtonText("\u6DFB\u52A0").setCta().onClick(()=>{this.isAddingMapping||this.addNewMapping()})),t.createEl("h3",{text:"\u5173\u952E\u5B57\u9AD8\u4EAE\u6837\u5F0F"}),new b.Setting(t).setName("\u9AD8\u4EAE\u6A21\u5F0F").setDesc("\u9009\u62E9\u5173\u952E\u5B57\u7684\u9AD8\u4EAE\u65B9\u5F0F").addDropdown(s=>s.addOption("first","\u9996\u6B21\u9AD8\u4EAE").addOption("all","\u5168\u90E8\u9AD8\u4EAE").setValue(this.plugin.settings.highlightStyle.mode).onChange(async o=>{this.plugin.settings.highlightStyle.mode=o,await this.plugin.saveSettings(),this.refreshEditorHighlight()})),new b.Setting(t).setName("\u80CC\u666F\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u80CC\u666F\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #FFFFFF00\uFF0C\u6700\u540E\u4E24\u4F4D\u4E3A\u900F\u660E\u5EA6\uFF09").addText(s=>s.setPlaceholder("#FFFFFF00").setValue(this.plugin.settings.highlightStyle.backgroundColor).onChange(async o=>{this.plugin.settings.highlightStyle.backgroundColor=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u6837\u5F0F").addDropdown(s=>s.addOption("solid","\u5B9E\u7EBF").addOption("dashed","\u865A\u7EBF").addOption("dotted","\u70B9\u7EBF").addOption("double","\u53CC\u7EBF").addOption("wavy","\u6CE2\u6D6A\u7EBF").setValue(this.plugin.settings.highlightStyle.borderStyle).onChange(async o=>{this.plugin.settings.highlightStyle.borderStyle=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u7C97\u7EC6\uFF080-10\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(0,10,1).setValue(this.plugin.settings.highlightStyle.borderWidth).setDynamicTooltip().onChange(async o=>{this.plugin.settings.highlightStyle.borderWidth=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u4E0B\u5212\u7EBF\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u4E0B\u5212\u7EBF\u989C\u8272").addText(s=>s.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.borderColor).onChange(async o=>{this.plugin.settings.highlightStyle.borderColor=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u5B57\u4F53\u7C97\u7EC6").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u7C97\u7EC6").addDropdown(s=>s.addOption("normal","\u6B63\u5E38").addOption("bold","\u7C97\u4F53").setValue(this.plugin.settings.highlightStyle.fontWeight).onChange(async o=>{this.plugin.settings.highlightStyle.fontWeight=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u5B57\u4F53\u6837\u5F0F").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u5B57\u4F53\u6837\u5F0F").addDropdown(s=>s.addOption("normal","\u6B63\u5E38").addOption("italic","\u659C\u4F53").setValue(this.plugin.settings.highlightStyle.fontStyle).onChange(async o=>{this.plugin.settings.highlightStyle.fontStyle=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),new b.Setting(t).setName("\u6587\u5B57\u989C\u8272").setDesc("\u9AD8\u4EAE\u5173\u952E\u5B57\u7684\u6587\u5B57\u989C\u8272\uFF08\u652F\u63018\u4F4DHEX\uFF0C\u5982 #4A86E9ff\uFF0Cinherit\u8868\u793A\u7EE7\u627F\u539F\u6709\u989C\u8272\uFF09").addText(s=>s.setPlaceholder("#4A86E9").setValue(this.plugin.settings.highlightStyle.color).onChange(async o=>{this.plugin.settings.highlightStyle.color=o,await this.plugin.saveSettings(),this.updateHighlightStyles()})),t.createEl("h3",{text:"\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B"}),new b.Setting(t).setName("\u542F\u7528\u5E38\u89C1\u6807\u70B9\u68C0\u6D4B").setDesc("\u4EC5\u5728\u5DF2\u914D\u7F6E\u5C0F\u8BF4\u5E93\u4E2D\u7684 Markdown \u6587\u4EF6\u5185\u8FDB\u884C\u68C0\u6D4B").addToggle(s=>s.setValue(this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.enabled=o,await e(),r(!o)})),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u9017\u53F7\uFF08,\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.comma).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.comma=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u53E5\u53F7\uFF08.\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.period).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.period=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5192\u53F7\uFF08:\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.colon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.colon=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u5206\u53F7\uFF08;\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.semicolon).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.semicolon=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u611F\u53F9\u53F7\uFF08!\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.exclamation).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.exclamation=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u82F1\u6587\u95EE\u53F7\uFF08?\uFF09").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.question).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.question=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u53CC\u5F15\u53F7").setDesc('\u68C0\u6D4B\u82F1\u6587\u53CC\u5F15\u53F7\uFF08"\uFF09\u4E0E\u4E2D\u6587\u53CC\u5F15\u53F7\uFF08\u201C\u201D\uFF09\u914D\u5BF9\u9519\u8BEF').addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.doubleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.doubleQuote=o,await e()})}),new b.Setting(t).setName("\u68C0\u6D4B\u5355\u5F15\u53F7").setDesc("\u68C0\u6D4B\u82F1\u6587\u5355\u5F15\u53F7\uFF08'\uFF09\u4E0E\u4E2D\u6587\u5355\u5F15\u53F7\uFF08\u2018\u2019\uFF09\u914D\u5BF9\u9519\u8BEF").addToggle(s=>{i.push(s),s.setValue(this.plugin.settings.punctuationCheck.singleQuote).setDisabled(!this.plugin.settings.punctuationCheck.enabled).onChange(async o=>{this.plugin.settings.punctuationCheck.singleQuote=o,await e()})}),t.createEl("h3",{text:"\u9884\u89C8\u680F\u8BBE\u7F6E"}),new b.Setting(t).setName("\u6B63\u6587\u60AC\u505C\u9884\u89C8").setDesc("\u5F00\u542F\u540E\uFF0C\u9F20\u6807\u60AC\u505C\u6B63\u6587\u9AD8\u4EAE\u5173\u952E\u8BCD\u65F6\u663E\u793A\u9884\u89C8\u680F").addToggle(s=>s.setValue(this.plugin.settings.enableEditorHoverPreview).onChange(async o=>{this.plugin.settings.enableEditorHoverPreview=o,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u53F3\u8FB9\u680F\u60AC\u505C\u9884\u89C8").setDesc("\u5F00\u542F\u540E\uFF0C\u9F20\u6807\u60AC\u505C\u53F3\u8FB9\u680F\u65F6\u663E\u793A\u9884\u89C8\u680F").addToggle(s=>s.setValue(this.plugin.settings.enableTreeH2HoverPreview).onChange(async o=>{this.plugin.settings.enableTreeH2HoverPreview=o,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u9884\u89C8\u680F\u5BBD\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u5BBD\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(240,720,20).setValue(this.plugin.settings.highlightPreviewStyle.width).setDynamicTooltip().onChange(async o=>{this.plugin.settings.highlightPreviewStyle.width=o,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u9884\u89C8\u680F\u9AD8\u5EA6").setDesc("\u60AC\u505C\u9884\u89C8\u680F\u6700\u5927\u9AD8\u5EA6\uFF08\u50CF\u7D20\uFF09").addSlider(s=>s.setLimits(160,800,20).setValue(this.plugin.settings.highlightPreviewStyle.height).setDynamicTooltip().onChange(async o=>{this.plugin.settings.highlightPreviewStyle.height=o,await this.plugin.saveSettings()})),new b.Setting(t).setName("\u4E0B\u65B9\u5185\u5BB9\u6700\u591A\u663E\u793A\u884C\u6570").setDesc("\u8D85\u8FC7\u8BE5\u884C\u6570\u65F6\u663E\u793A\u6EDA\u52A8\u6761").addSlider(s=>s.setLimits(3,50,1).setValue(this.plugin.settings.highlightPreviewStyle.maxBodyLines).setDynamicTooltip().onChange(async o=>{this.plugin.settings.highlightPreviewStyle.maxBodyLines=o,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u6587\u4EF6\u6253\u5F00\u884C\u4E3A"}),new b.Setting(t).setName("\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00").setDesc("\u901A\u8FC7\u63D2\u4EF6\u5185\u76F8\u5173\u529F\u80FD\u6253\u5F00\u6216\u65B0\u5EFA\u6587\u4EF6\u65F6\uFF0C\u662F\u5426\u5728\u65B0\u6807\u7B7E\u9875\u6253\u5F00\uFF08\u5DF2\u6253\u5F00\u5219\u590D\u7528\u73B0\u6709\u6807\u7B7E\uFF09").addToggle(s=>s.setValue(this.plugin.settings.openInNewTab).onChange(async o=>{this.plugin.settings.openInNewTab=o,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u7F16\u8F91\u533A\u6392\u7248"}),new b.Setting(t).setName("\u542F\u7528\u7F16\u8F91\u533A\u6392\u7248").setDesc("\u5173\u95ED\u540E\u4E0D\u5E94\u7528\u884C\u9996\u7F29\u8FDB\u3001\u884C\u95F4\u8DDD\u548C\u6BB5\u95F4\u8DDD").addToggle(s=>s.setValue(this.plugin.settings.enableEditorTypography).onChange(async o=>{this.plugin.settings.enableEditorTypography=o,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),new b.Setting(t).setName("\u884C\u9996\u7F29\u8FDB\uFF08\u4E2D\u6587\u5B57\u7B26\uFF09").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548\uFF0C\u6309\u4E2D\u6587\u5B57\u7B26\u5BBD\u5EA6\u7F29\u8FDB").addSlider(s=>s.setLimits(0,6,.5).setValue(this.plugin.settings.editorIndentCjkChars).setDynamicTooltip().onChange(async o=>{this.plugin.settings.editorIndentCjkChars=o,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),new b.Setting(t).setName("\u884C\u95F4\u8DDD").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548").addSlider(s=>s.setLimits(1.2,2.6,.1).setValue(this.plugin.settings.editorLineHeight).setDynamicTooltip().onChange(async o=>{this.plugin.settings.editorLineHeight=o,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),new b.Setting(t).setName("\u6BB5\u95F4\u8DDD").setDesc("\u4EC5\u7F16\u8F91\u89C6\u56FE\u751F\u6548\uFF1B\u4E0E\u884C\u95F4\u8DDD\u72EC\u7ACB\uFF0C\u4E0D\u53E0\u52A0").addSlider(s=>s.setLimits(0,32,1).setValue(this.plugin.settings.editorParagraphSpacing).setDynamicTooltip().onChange(async o=>{this.plugin.settings.editorParagraphSpacing=o,await this.plugin.saveSettings(),this.updateEditorTypographyStyles()})),t.createEl("h3",{text:"\u4FBF\u6377\u529F\u80FD"}),new b.Setting(t).setName("\u542F\u7528\u5B57\u7B26\u6570\u7EDF\u8BA1").setDesc("\u5173\u95ED\u540E\u4E0D\u663E\u793A\u7EDF\u8BA1\uFF0C\u4E14\u4E0D\u5728\u540E\u53F0\u6267\u884C\u5B57\u7B26\u7EDF\u8BA1").addToggle(s=>s.setValue(this.plugin.settings.enableMdStats).onChange(async o=>{this.plugin.settings.enableMdStats=o,await this.plugin.saveSettings(),this.plugin.mdStatsManager.setEnabled(o)}))}renderMappings(t){if(t.empty(),this.plugin.settings.folderMappings.length===0){t.createEl("p",{text:"\u6682\u65E0\u5BF9\u5E94\u5173\u7CFB\uFF0C\u8BF7\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u6DFB\u52A0\u3002",cls:"setting-item-description"});return}this.plugin.settings.folderMappings.forEach((e,i)=>{let r=`${e.novelFolder||"\u672A\u8BBE\u7F6E"} \u2192 ${e.settingFolder||"\u672A\u8BBE\u7F6E"}`;new b.Setting(t).setName(r).setClass("folder-mapping-item").addButton(n=>n.setButtonText("\u7F16\u8F91").onClick(async()=>{await this.editMapping(e)})).addButton(n=>n.setButtonText("\u5220\u9664").setWarning().onClick(async()=>{e.settingFolder&&await this.plugin.orderManager.removeFolderData(e.settingFolder),this.plugin.settings.folderMappings=this.plugin.settings.folderMappings.filter(s=>s.id!==e.id),await this.plugin.saveSettings(),await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()}))})}async editMapping(t){let{TextInputModal:e}=await Promise.resolve().then(()=>(O(),q)),i=t.settingFolder;new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.novelFolder,async r=>{r.trim()&&setTimeout(()=>{new e(this.app,"\u7F16\u8F91\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09",t.settingFolder,async n=>{n.trim()&&(t.novelFolder=r.trim(),t.settingFolder=n.trim(),i&&await this.plugin.orderManager.removeFolderData(i),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display()},50))}).open()},100)}).open()}async addNewMapping(){if(this.isAddingMapping)return;this.isAddingMapping=!0;let{TextInputModal:t}=await Promise.resolve().then(()=>(O(),q));new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 1/2","\u8BF7\u8F93\u5165\u5C0F\u8BF4\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async e=>{if(!e.trim()){this.isAddingMapping=!1;return}setTimeout(()=>{new t(this.app,"\u6DFB\u52A0\u5BF9\u5E94\u5173\u7CFB - \u6B65\u9AA4 2/2","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u5E93\u8DEF\u5F84\uFF08\u76F8\u5BF9\u4E8E\u4ED3\u5E93\u6839\u76EE\u5F55\uFF09","",async i=>{if(!i.trim()){this.isAddingMapping=!1;return}let r={id:Date.now().toString(),novelFolder:e.trim(),settingFolder:i.trim()};this.plugin.settings.folderMappings.push(r),await this.plugin.saveSettings(),setTimeout(async()=>{await this.plugin.refreshView(),this.refreshEditorHighlight(),this.display(),this.isAddingMapping=!1},50)}).open()},100)}).open()}updateHighlightStyles(){this.plugin.highlightManager&&this.plugin.highlightManager.updateStyles()}refreshEditorHighlight(){this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}updateEditorTypographyStyles(){this.plugin.editorTypographyManager&&this.plugin.editorTypographyManager.updateStyles()}};var Y=require("obsidian"),A=class{constructor(a){this.parseCache=new Map;this.vault=a}async parseFolder(a){let t=[],e=this.vault.getAbstractFileByPath(a);if(!e||!(e instanceof Y.TFile)){let r=this.vault.getMarkdownFiles().filter(n=>n.path.startsWith(a));for(let n of r){let s=await this.parseFile(n);s&&t.push(s)}}return t}async parseFile(a){if(a.extension!=="md")return null;let t=this.parseCache.get(a.path);if(t&&t.mtime===a.stat.mtime&&t.size===a.stat.size)return t.result;let i=(await this.vault.read(a)).split(`
`),r=[],n=null,s=null;for(let l=0;l<i.length;l++){let h=i[l];if(!h)continue;let c=h.trim();c.startsWith("# ")&&!c.startsWith("## ")?(s&&n&&(n.h2List.push(s),s=null),n&&r.push(n),n={text:c.substring(2).trim(),lineNumber:l,h2List:[]}):c.startsWith("## ")&&!c.startsWith("### ")&&n?(s&&n.h2List.push(s),s={text:c.substring(3).trim(),lineNumber:l,content:[]}):s&&h&&c.length>0&&s.content.push(h)}s&&n&&n.h2List.push(s),n&&r.push(n);let o={filePath:a.path,fileName:a.basename,h1List:r};return this.parseCache.set(a.path,{mtime:a.stat.mtime,size:a.stat.size,result:o}),o}getMarkdownFilesInFolder(a){return this.vault.getMarkdownFiles().filter(e=>a===""?!0:e.path.startsWith(a+"/")||e.path===a)}};var F=require("obsidian"),_=require("@codemirror/view");O();var H="chinese-writer-tree-view",D=class extends F.ItemView{constructor(t,e){super(t);this.treeData=[];this.allExpanded=!1;this.lastObservedActiveFilePath=null;this.currentSettingFolder=null;this.draggedNode=null;this.dropIndicator=null;this.insertBefore=!1;this.plugin=e}getViewType(){return H}getDisplayText(){return"\u4E2D\u6587\u5199\u4F5C"}getIcon(){return"book-type"}async onOpen(){var t,e;await this.refresh(),this.lastObservedActiveFilePath=(e=(t=this.getContextFile())==null?void 0:t.path)!=null?e:null,this.registerEvent(this.app.workspace.on("active-leaf-change",async i=>{var n,s;let r=this.lastObservedActiveFilePath;(i==null?void 0:i.view)instanceof F.MarkdownView&&(r=(s=(n=i.view.file)==null?void 0:n.path)!=null?s:null),r!==this.lastObservedActiveFilePath&&(this.lastObservedActiveFilePath=r,await this.smartUpdate())}))}async onClose(){this.removeDropIndicator()}async refresh(){let t=this.containerEl.children[1];if(!t)return;t.empty(),t.addClass("chinese-writer-view");let e=t.createDiv({cls:"chinese-writer-header"}),i=e.createDiv({cls:"chinese-writer-title"}),r=i.createSpan({cls:"chinese-writer-icon"});(0,F.setIcon)(r,"book-type");let n=this.getContextFile(),s="\u672A\u8BBE\u7F6E\u76EE\u5F55";if(n){let h=this.plugin.highlightManager.getSettingFolderForFile(n.path);h&&(s=this.getFolderDisplayName(h))}i.createSpan({text:s,cls:"chinese-writer-folder-name"});let o=e.createEl("button",{cls:"chinese-writer-toggle-btn"});(0,F.setIcon)(o,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down"),o.setAttribute("aria-label","\u5C55\u5F00/\u6298\u53E0\u5168\u90E8"),o.addEventListener("click",()=>{this.toggleAllNodes()});let l=t.createDiv({cls:"chinese-writer-tree-container"});l.addEventListener("contextmenu",h=>{let c=h.target;(c.classList.contains("chinese-writer-tree-container")||c.classList.contains("chinese-writer-tree")||c.classList.contains("chinese-writer-empty"))&&(h.preventDefault(),h.stopPropagation(),this.showEmptyAreaContextMenu(h))}),await this.loadData(),this.renderTree(l,this.treeData)}async smartUpdate(){let t=this.saveExpandedStates();await this.persistExpandedStatesForCurrentFolder(t),await this.loadData(),this.restoreExpandedStates(t);let e=this.containerEl.children[1];if(!e)return;this.updateHeaderFolderName(e);let i=e.querySelector(".chinese-writer-tree-container");i&&(i.empty(),this.renderTree(i,this.treeData))}saveExpandedStates(){let t=new Map;return this.collectExpandedStates(this.treeData,t),t}collectExpandedStates(t,e,i=""){t.forEach(r=>{if(r.children.length===0)return;let n=this.getNodeKey(r,i);e.set(n,r.expanded),this.collectExpandedStates(r.children,e,n)})}getNodeKey(t,e=""){let i="";return t.type==="file"&&t.filePath?i=`file:${t.filePath}`:t.type==="h1"?i=`${e}>>h1:${t.text}`:t.type==="h2"?i=`${e}>>h2:${t.text}`:i=t.id,i}restoreExpandedStates(t){this.applyExpandedStates(this.treeData,t,"")}applyExpandedStates(t,e,i=""){t.forEach(r=>{let n=this.getNodeKey(r,i),s=e.get(n);s!==void 0&&(r.expanded=s),r.children.length>0&&this.applyExpandedStates(r.children,e,n)})}async loadData(){let t=this.getContextFile(),e=null;if(t&&(e=this.plugin.highlightManager.getSettingFolderForFile(t.path)),this.currentSettingFolder=e,!e){this.treeData=[];return}let i=this.plugin.parser,r=i.getMarkdownFilesInFolder(e),s=(await Promise.all(r.map(d=>i.parseFile(d)))).filter(d=>d!==null),o=this.plugin.orderManager.getFileOrder();o.length===0&&s.length>0&&(o=s.map(d=>d.filePath),await this.plugin.orderManager.setFileOrder(o)),o.length>0&&s.sort((d,p)=>{let u=o.indexOf(d.filePath),g=o.indexOf(p.filePath);return u===-1&&g===-1?0:u===-1?1:g===-1?-1:u-g}),this.treeData=[];let l=0;for(let d of s){let p=this.createFileNode(d,l++);this.treeData.push(p)}let h=this.plugin.orderManager.getExpandedStates(e),c=Object.entries(h);c.length>0&&this.restoreExpandedStates(new Map(c))}createFileNode(t,e){let i={id:`file-${e}`,text:t.fileName,type:"file",children:[],expanded:!1,filePath:t.filePath};return t.h1List.forEach((r,n)=>{let s={id:`${i.id}-h1-${n}`,text:r.text,type:"h1",children:[],expanded:!1};r.h2List.forEach((o,l)=>{let h=this.extractStatusFromLines(o.content),c={id:`${s.id}-h2-${l}`,text:o.text,type:"h2",children:[],expanded:!1,content:o.content,status:h};s.children.push(c)}),i.children.push(s)}),i}renderTree(t,e){if(e.length===0){t.createDiv({text:"\u672A\u627E\u5230\u6587\u4EF6\u6216\u76EE\u5F55\u4E3A\u7A7A",cls:"chinese-writer-empty"});return}let i=t.createEl("ul",{cls:"chinese-writer-tree"});e.forEach(r=>{this.renderNode(i,r)})}renderNode(t,e){let i=t.createEl("li",{cls:"tree-item"});i.setAttribute("data-node-id",e.id),i.setAttribute("data-node-type",e.type);let r=i.createDiv({cls:"tree-item-content"});if(r.setAttribute("draggable","true"),r.addEventListener("dragstart",l=>{l.stopPropagation(),this.onDragStart(l,e)}),r.addEventListener("dragover",l=>{l.stopPropagation(),this.onDragOver(l,e)}),r.addEventListener("dragleave",l=>{l.stopPropagation(),this.onDragLeave(l)}),r.addEventListener("drop",l=>{l.stopPropagation(),this.onDrop(l,e)}),r.addEventListener("dragend",l=>{l.stopPropagation(),this.onDragEnd(l)}),e.children.length>0){let l=r.createSpan({cls:"tree-item-toggle"});(0,F.setIcon)(l,e.expanded?"chevron-down":"chevron-right"),l.addEventListener("click",h=>{h.stopPropagation(),this.toggleNode(e,i)})}else r.createSpan({cls:"tree-item-toggle-placeholder"});let n=r.createSpan({cls:"tree-item-icon"}),s=e.type==="file"?"file-text":e.type==="h1"?"heading-1":"heading-2";(0,F.setIcon)(n,s),n.addEventListener("click",l=>{l.stopPropagation()});let o=r.createSpan({text:e.text,cls:`tree-item-text tree-item-${e.type}`});if(e.type==="h2"&&this.isDeadStatus(e.status)&&o.addClass("tree-item-h2-dead"),e.type==="h2"){let l=this.findParentH1Node(e),h=this.findParentFileNode(e);this.currentSettingFolder&&l&&(h!=null&&h.filePath)&&(r.addClass("cw-tree-preview-anchor"),r.setAttribute("data-cw-tree-setting-folder",this.currentSettingFolder),r.setAttribute("data-cw-tree-file-path",h.filePath),r.setAttribute("data-cw-tree-h1",l.text),r.setAttribute("data-cw-tree-h2",e.text),r.setAttribute("data-cw-tree-keyword",e.text))}if(e.type==="file"||e.type==="h1"){let l=this.countH2(e);if(l>0){let h=r.createSpan({text:`[${l}]`,cls:"tree-item-count"})}}if(r.addEventListener("click",()=>{this.onNodeClick(e)}),r.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),this.showContextMenu(l,e)}),e.children.length>0){let l=i.createEl("ul",{cls:"tree-item-children"});e.expanded||(l.style.display="none"),e.children.forEach(h=>{this.renderNode(l,h)})}}toggleNode(t,e){t.expanded=!t.expanded;let i=e.querySelector(".tree-item-toggle"),r=e.querySelector(".tree-item-children");i&&(i.empty(),(0,F.setIcon)(i,t.expanded?"chevron-down":"chevron-right")),r&&(r.style.display=t.expanded?"block":"none"),this.persistExpandedStatesForCurrentFolder()}toggleAllNodes(){this.allExpanded=!this.allExpanded,this.setAllNodesExpanded(this.treeData,this.allExpanded),this.updateAllNodesInDOM(this.allExpanded);let t=this.containerEl.children[1];if(!t)return;let e=t.querySelector(".chinese-writer-toggle-btn");e&&(e.empty(),(0,F.setIcon)(e,this.allExpanded?"list-chevrons-down-up":"list-chevrons-up-down")),this.persistExpandedStatesForCurrentFolder()}setAllNodesExpanded(t,e){t.forEach(i=>{i.expanded=e,i.children.length>0&&this.setAllNodesExpanded(i.children,e)})}updateAllNodesInDOM(t){let e=this.containerEl.children[1];if(!e)return;e.querySelectorAll(".tree-item").forEach(r=>{let n=r.getAttribute("data-node-id");if(!n)return;let s=this.findNodeById(this.treeData,n);if(!s||s.children.length===0)return;let o=r.querySelector(".tree-item-toggle");o&&(o.empty(),(0,F.setIcon)(o,t?"chevron-down":"chevron-right"));let l=r.querySelector(".tree-item-children");l&&(l.style.display=t?"block":"none")})}findNodeById(t,e){for(let i of t){if(i.id===e)return i;if(i.children.length>0){let r=this.findNodeById(i.children,e);if(r)return r}}return null}countH2(t){let e=0;return t.type==="file"?t.children.forEach(i=>{e+=i.children.length}):t.type==="h1"&&(e=t.children.length),e}onNodeClick(t){}getContextFile(){let t=this.app.workspace.getActiveFile();if(t)return t;if(this.lastObservedActiveFilePath){let e=this.app.vault.getAbstractFileByPath(this.lastObservedActiveFilePath);if(e instanceof F.TFile)return e}return null}extractStatusFromLines(t){let e="\u3010\u72B6\u6001\u3011";for(let i of t){let r=i.indexOf(e);if(r===-1)continue;let n=i.slice(r+e.length).trim();if(n)return n}return""}isDeadStatus(t){if(!t)return!1;let e=t.trim();return e==="\u6B7B\u4EA1"||e==="\u5931\u6548"}updateHeaderFolderName(t){let e=t.querySelector(".chinese-writer-folder-name");e&&e.setText(this.getFolderDisplayName(this.currentSettingFolder))}getFolderDisplayName(t){var i;if(!t)return"\u672A\u8BBE\u7F6E\u76EE\u5F55";let e=t.split(/[\\/]/).map(r=>r.trim()).filter(r=>r.length>0);return(i=e[e.length-1])!=null?i:"\u672A\u8BBE\u7F6E\u76EE\u5F55"}async persistExpandedStatesForCurrentFolder(t){if(!this.currentSettingFolder)return;let e=t!=null?t:this.saveExpandedStates(),i={};e.forEach((r,n)=>{i[n]=r}),await this.plugin.orderManager.setExpandedStates(this.currentSettingFolder,i)}onDragStart(t,e){this.draggedNode=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.id),this.createDropIndicator()}onDragOver(t,e){if(t.preventDefault(),!this.draggedNode)return;if(this.draggedNode.type==="h1"&&e.type==="file"){t.dataTransfer.dropEffect="move";let s=t.currentTarget;this.showDropIndicator(s,!1);return}if(this.draggedNode.type==="h2"&&e.type==="h1"){t.dataTransfer.dropEffect="move";let s=t.currentTarget;this.showDropIndicator(s,!1);return}if(e.type!==this.draggedNode.type){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}if(e.id===this.draggedNode.id){this.hideDropIndicator(),t.dataTransfer.dropEffect="none";return}t.dataTransfer.dropEffect="move";let i=t.currentTarget,r=i.getBoundingClientRect(),n=r.top+r.height/2;this.insertBefore=t.clientY<n,this.showDropIndicator(i,this.insertBefore)}createDropIndicator(){this.dropIndicator||(this.dropIndicator=document.createElement("div"),this.dropIndicator.addClass("drop-indicator"),document.body.appendChild(this.dropIndicator))}showDropIndicator(t,e){if(!this.dropIndicator||!this.draggedNode)return;let i=t.getBoundingClientRect();this.dropIndicator.style.display="block",this.dropIndicator.style.left=`${i.left}px`,this.dropIndicator.style.width=`${i.width}px`,e?this.dropIndicator.style.top=`${i.top-1}px`:this.dropIndicator.style.top=`${i.bottom-1}px`}onDragLeave(t){let e=t.currentTarget,i=t.relatedTarget;e.contains(i)}hideDropIndicator(){this.dropIndicator&&(this.dropIndicator.style.display="none")}removeDropIndicator(){this.dropIndicator&&(this.dropIndicator.remove(),this.dropIndicator=null)}async onDrop(t,e){if(t.preventDefault(),t.stopPropagation(),this.hideDropIndicator(),!(!this.draggedNode||this.draggedNode.id===e.id)){if(this.draggedNode.type==="h1"&&e.type==="file"){await this.moveH1ToFileEnd(this.draggedNode,e);return}if(this.draggedNode.type==="h2"&&e.type==="h1"){await this.moveH2ToH1End(this.draggedNode,e);return}this.draggedNode.type===e.type&&await this.reorderNodes(this.draggedNode,e)}}onDragEnd(t){t.currentTarget.removeClass("dragging"),this.removeDropIndicator(),this.draggedNode=null}async moveH2ToH1End(t,e){let i=this.findParentH1Node(t),r=this.findParentFileNode(t),n=this.findParentFileNode(e);!i||!r||!n||i.id!==e.id&&(!r.filePath||!n.filePath||(await this.plugin.orderManager.moveH2ToEndOfH1(r.filePath,i.text,n.filePath,e.text,t.text),await this.smartUpdate()))}async moveH1ToFileEnd(t,e){let i=this.findParentFileNode(t);i&&i.id!==e.id&&(!i.filePath||!e.filePath||(await this.plugin.orderManager.moveH1ToEndOfFile(i.filePath,e.filePath,t.text),await this.smartUpdate()))}async reorderNodes(t,e){t.type==="file"?await this.reorderFiles(t,e):t.type==="h1"?await this.reorderH1(t,e):t.type==="h2"&&await this.reorderH2(t,e)}async reorderFiles(t,e){if(!t.filePath||!e.filePath)return;let i=this.treeData.map(o=>o.filePath).filter(o=>o!==void 0),r=i.indexOf(t.filePath),n=i.indexOf(e.filePath);if(r===-1||n===-1)return;let[s]=i.splice(r,1);s&&(n=i.indexOf(e.filePath),this.insertBefore?i.splice(n,0,s):i.splice(n+1,0,s),await this.plugin.orderManager.setFileOrder(i),await this.smartUpdate())}async reorderH1(t,e){let i=this.findParentFileNode(t),r=this.findParentFileNode(e);if(!i||!r)return;if(i.id===r.id){if(!i.filePath)return;let s=i.children.map(c=>c.text),o=s.indexOf(t.text),l=s.indexOf(e.text);if(o===-1||l===-1)return;let[h]=s.splice(o,1);if(!h)return;l=s.indexOf(e.text),this.insertBefore?s.splice(l,0,h):s.splice(l+1,0,h),await this.plugin.orderManager.reorderH1InFile(i.filePath,s)}else{if(!i.filePath||!r.filePath)return;await this.plugin.orderManager.moveH1BetweenFiles(i.filePath,r.filePath,t.text,e.text,this.insertBefore)}await this.smartUpdate()}async reorderH2(t,e){let i=this.findParentH1Node(t),r=this.findParentH1Node(e),n=this.findParentFileNode(t),s=this.findParentFileNode(e);if(!i||!r||!n||!s)return;if(i.id===r.id){if(!n.filePath)return;let l=i.children.map(p=>p.text),h=l.indexOf(t.text),c=l.indexOf(e.text);if(h===-1||c===-1)return;let[d]=l.splice(h,1);if(!d)return;c=l.indexOf(e.text),this.insertBefore?l.splice(c,0,d):l.splice(c+1,0,d),await this.plugin.orderManager.reorderH2InFile(n.filePath,i.text,l)}else{if(!n.filePath||!s.filePath)return;await this.plugin.orderManager.moveH2BetweenH1s(n.filePath,i.text,s.filePath,r.text,t.text,e.text,this.insertBefore)}await this.smartUpdate()}findParentFileNode(t){let e=t.id.match(/^file-(\d+)/);if(!e||!e[1])return null;let i=parseInt(e[1]);return this.treeData[i]||null}findParentH1Node(t){let e=t.id.match(/^file-(\d+)-h1-(\d+)/);if(!e||!e[1]||!e[2])return null;let i=parseInt(e[1]),r=parseInt(e[2]),n=this.treeData[i];return n&&n.children[r]||null}showContextMenu(t,e){let i=new F.Menu;e.type==="file"?this.addH1ContextMenu(i,e):e.type==="h1"?this.addH2ContextMenu(i,e):e.type==="h2"&&this.addH2SelfContextMenu(i,e),i.showAtMouseEvent(t)}showEmptyAreaContextMenu(t){let e=new F.Menu;this.addFileContextMenuForEmpty(e),e.showAtMouseEvent(t)}addFileContextMenuForEmpty(t){t.addItem(e=>{e.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})})}addH1ContextMenu(t,e){t.addItem(i=>{i.setTitle("\u521B\u5EFA\u96C6\u5408").setIcon("file-text").onClick(async()=>{await this.createFile()})}),t.addItem(i=>{i.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(e)})}),t.addSeparator(),t.addItem(i=>{i.setTitle("\u91CD\u547D\u540D\u96C6\u5408").setIcon("pencil").onClick(async()=>{await this.renameFile(e)})}),t.addItem(i=>{i.setTitle("\u5220\u9664\u96C6\u5408").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteFile(e)})})}addH2ContextMenu(t,e){let i=this.findParentFileNode(e);i&&t.addItem(r=>{r.setTitle("\u521B\u5EFA\u5206\u7C7B").setIcon("heading-1").onClick(async()=>{await this.createH1(i)})}),t.addItem(r=>{r.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(e)})}),t.addSeparator(),t.addItem(r=>{r.setTitle("\u91CD\u547D\u540D\u5206\u7C7B").setIcon("pencil").onClick(async()=>{await this.renameH1(e)})}),t.addItem(r=>{r.setTitle("\u5220\u9664\u5206\u7C7B").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH1(e)})})}addH2SelfContextMenu(t,e){let i=this.findParentH1Node(e);i&&t.addItem(r=>{r.setTitle("\u521B\u5EFA\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.createH2(i)})}),t.addItem(r=>{r.setTitle("\u7F16\u8F91\u8BBE\u5B9A").setIcon("heading-2").onClick(async()=>{await this.editH2(e)})}),t.addSeparator(),t.addItem(r=>{r.setTitle("\u91CD\u547D\u540D\u8BBE\u5B9A").setIcon("pencil").onClick(async()=>{await this.renameH2(e)})}),t.addItem(r=>{r.setTitle("\u5220\u9664\u8BBE\u5B9A").setIcon("trash").setWarning(!0).onClick(async()=>{await this.deleteH2(e)})})}async createFile(){new P(this.app,"\u521B\u5EFA\u96C6\u5408","\u8BF7\u8F93\u5165\u96C6\u5408\u540D\u79F0","",async e=>{if(!e.trim())return;let i=this.app.workspace.getActiveFile(),r=null;if(i&&(r=this.plugin.highlightManager.getSettingFolderForFile(i.path)),!r)return;let n=e.trim(),s=`${r}/${n}.md`;if(this.app.vault.getAbstractFileByPath(s))return;let l=await this.app.vault.create(s,"");await this.plugin.openFileWithSettings(l);let h=this.plugin.orderManager.getFileOrder();h.length===0?h=this.plugin.parser.getMarkdownFilesInFolder(r).map(p=>p.path):h.push(s),await this.plugin.orderManager.setFileOrder(h),await new Promise(c=>setTimeout(c,400)),await this.smartUpdate()}).open()}async renameFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof F.TFile))return;new P(this.app,"\u91CD\u547D\u540D\u96C6\u5408","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async r=>{if(!r.trim()||r.trim()===t.text)return;let n=r.trim(),o=`${t.filePath.substring(0,t.filePath.lastIndexOf("/"))}/${n}.md`;await this.app.fileManager.renameFile(e,o);let l=this.plugin.orderManager.getFileOrder(),h=l.indexOf(t.filePath);h!==-1&&(l[h]=o,await this.plugin.orderManager.setFileOrder(l)),await this.smartUpdate()}).open()}async deleteFile(t){if(!t.filePath)return;let e=this.app.vault.getAbstractFileByPath(t.filePath);if(!(e instanceof F.TFile))return;new k(this.app,"\u5220\u9664\u96C6\u5408",`\u786E\u5B9A\u8981\u5220\u9664\u96C6\u5408"${t.text}"\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let r=this.plugin.orderManager.getFileOrder();if(r.length===0){let s=this.app.workspace.getActiveFile(),o=null;s&&(o=this.plugin.highlightManager.getSettingFolderForFile(s.path)),o&&(r=this.plugin.parser.getMarkdownFilesInFolder(o).map(c=>c.path))}await this.app.vault.delete(e);let n=r.indexOf(t.filePath);n!==-1&&(r.splice(n,1),await this.plugin.orderManager.setFileOrder(r)),await new Promise(s=>setTimeout(s,400)),await this.smartUpdate()}).open()}async createH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new P(this.app,"\u521B\u5EFA\u5206\u7C7B","\u8BF7\u8F93\u5165\u5206\u7C7B\u540D\u79F0","",async r=>{if(!r.trim())return;let n=r.trim(),s=this.app.vault.getAbstractFileByPath(e.filePath);if(!(s instanceof F.TFile))return;let l=(await this.app.vault.read(s)).split(`
`);l.push(`# ${n}`),await this.app.vault.modify(s,l.join(`
`)),await this.smartUpdate()}).open()}async renameH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new P(this.app,"\u91CD\u547D\u540D\u5206\u7C7B","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async r=>{if(!r.trim()||r.trim()===t.text)return;let n=r.trim(),s=this.app.vault.getAbstractFileByPath(e.filePath);if(!(s instanceof F.TFile))return;let l=(await this.app.vault.read(s)).split(`
`);for(let h=0;h<l.length;h++){let c=l[h];if(!c)continue;let d=c.trim();if(d.startsWith("# ")&&!d.startsWith("## ")&&d.substring(2).trim()===t.text){l[h]=`# ${n}`;break}}await this.app.vault.modify(s,l.join(`
`)),await this.smartUpdate()}).open()}async deleteH1(t){let e=this.findParentFileNode(t);if(!e||!e.filePath)return;new k(this.app,"\u5220\u9664\u5206\u7C7B",`\u786E\u5B9A\u8981\u5220\u9664\u5206\u7C7B"${t.text}"\u53CA\u5176\u4E0B\u7684\u6240\u6709\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let r=this.app.vault.getAbstractFileByPath(e.filePath);if(!(r instanceof F.TFile))return;let s=(await this.app.vault.read(r)).split(`
`),o=-1,l=s.length,h=!1;for(let d=0;d<s.length;d++){let p=s[d];if(!p)continue;let u=p.trim();if(u.startsWith("# ")&&!u.startsWith("## ")){if(u.substring(2).trim()===t.text)o=d,h=!0;else if(h){l=d;break}}}if(o===-1)return;let c=[...s.slice(0,o),...s.slice(l)];await this.app.vault.modify(r,c.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async createH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new P(this.app,"\u521B\u5EFA\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u8BBE\u5B9A\u540D\u79F0","",async n=>{if(!n.trim())return;let s=n.trim(),o=this.app.vault.getAbstractFileByPath(i.filePath);if(!(o instanceof F.TFile))return;let h=(await this.app.vault.read(o)).split(`
`),c=h.length,d=!1;for(let u=0;u<h.length;u++){let g=h[u];if(!g)continue;let v=g.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(v.substring(2).trim()===e.text)d=!0;else if(d){c=u;break}}}let p=[...h.slice(0,c),`## ${s}`,...h.slice(c)];await this.app.vault.modify(o,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async renameH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new P(this.app,"\u91CD\u547D\u540D\u8BBE\u5B9A","\u8BF7\u8F93\u5165\u65B0\u540D\u79F0",t.text,async n=>{if(!n.trim()||n.trim()===t.text)return;let s=n.trim(),o=this.app.vault.getAbstractFileByPath(i.filePath);if(!(o instanceof F.TFile))return;let h=(await this.app.vault.read(o)).split(`
`),c=!1;for(let d=0;d<h.length;d++){let p=h[d];if(!p)continue;let u=p.trim();if(u.startsWith("# ")&&!u.startsWith("## "))c=u.substring(2).trim()===e.text;else if(c&&u.startsWith("## ")&&!u.startsWith("### ")&&u.substring(3).trim()===t.text){h[d]=`## ${s}`;break}}await this.app.vault.modify(o,h.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async deleteH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;new k(this.app,"\u5220\u9664\u8BBE\u5B9A",`\u786E\u5B9A\u8981\u5220\u9664\u8BBE\u5B9A"${t.text}"\u53CA\u5176\u5185\u5BB9\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u6062\u590D\u3002`,async()=>{let n=this.app.vault.getAbstractFileByPath(i.filePath);if(!(n instanceof F.TFile))return;let o=(await this.app.vault.read(n)).split(`
`),l=-1,h=o.length,c=!1,d=!1;for(let u=0;u<o.length;u++){let g=o[u];if(!g)continue;let v=g.trim();if(v.startsWith("# ")&&!v.startsWith("## ")){if(c=v.substring(2).trim()===e.text,c===!1&&d){h=u;break}}else if(c&&v.startsWith("## ")&&!v.startsWith("### ")){if(v.substring(3).trim()===t.text)l=u,d=!0;else if(d){h=u;break}}}if(l===-1)return;let p=[...o.slice(0,l),...o.slice(h)];await this.app.vault.modify(n,p.join(`
`)),await this.smartUpdate(),this.plugin.highlightManager&&this.plugin.highlightManager.refreshCurrentEditor()}).open()}async editH2(t){let e=this.findParentH1Node(t),i=this.findParentFileNode(t);if(!e||!i||!i.filePath)return;let r=this.app.vault.getAbstractFileByPath(i.filePath);if(!(r instanceof F.TFile))return;let s=(await this.app.vault.read(r)).split(`
`),o=this.findFirstContentLine(s,e.text,t.text),l=await this.plugin.openFileWithSettings(r,{revealWhenNewTab:!0});if(!l)return;let h=l.view instanceof F.MarkdownView?l.view:null;h!=null&&h.editor&&(h.editor.setCursor({line:o,ch:0}),this.centerEditorLine(h.editor,o))}centerEditorLine(t,e){let i=t.cm;if(!i)return;let r=Math.max(0,Math.min(e,i.state.doc.lines-1)),n=i.state.doc.line(r+1).from,s=()=>{i.dispatch({effects:_.EditorView.scrollIntoView(n,{y:"center",yMargin:0})})};s(),window.setTimeout(s,30)}findFirstContentLine(t,e,i){var o,l;let r=!1,n=!1,s=0;for(let h=0;h<t.length;h++){let c=(l=(o=t[h])==null?void 0:o.trim())!=null?l:"";if(c.startsWith("# ")&&!c.startsWith("## ")){r=c.slice(2).trim()===e,n=!1;continue}if(r&&c.startsWith("## ")&&!c.startsWith("### ")){n=c.slice(3).trim()===i,n&&(s=h);continue}if(n){if(c.startsWith("#"))break;if(c.length>0)return h}}return s}};var E=require("obsidian"),V=class{constructor(a,t){this.saveTimeout=null;this.isSaving=!1;this.app=a,this.viewDataFilePath=`${t}/cw-view-datas.json`,this.legacyViewDataFilePath=`${t}/view-datas.json`,this.legacyOrderFilePath=`${t}/order.json`,this.orderData={files:[],expandedStatesByFolder:{}}}async load(){try{let a=this.app.vault.adapter,t=await a.exists(this.viewDataFilePath),e=await a.exists(this.legacyViewDataFilePath),i=await a.exists(this.legacyOrderFilePath),r=this.viewDataFilePath;if(!t&&e?r=this.legacyViewDataFilePath:!t&&i&&(r=this.legacyOrderFilePath),!await a.exists(r)){this.orderData={files:[],expandedStatesByFolder:{}};return}let s=await a.read(r),o=JSON.parse(s),l=Array.isArray(o==null?void 0:o.files)?o.files.filter(c=>typeof c=="string"&&c.length>0):[],h={};if(o!=null&&o.expandedStatesByFolder&&typeof o.expandedStatesByFolder=="object")for(let[c,d]of Object.entries(o.expandedStatesByFolder)){if(!d||typeof d!="object")continue;let p={};for(let[u,g]of Object.entries(d))typeof g=="boolean"&&(u.includes(">>h2:")||(p[u]=g));h[c]=p}this.orderData={files:l,expandedStatesByFolder:h},r===this.legacyOrderFilePath&&!t&&await this.saveNow(),r===this.legacyViewDataFilePath&&!t&&await this.saveNow()}catch(a){this.orderData={files:[],expandedStatesByFolder:{}}}}async save(){return this.saveTimeout&&clearTimeout(this.saveTimeout),new Promise(a=>{this.saveTimeout=setTimeout(async()=>{await this.saveNow(),a()},300)})}async saveNow(){if(this.isSaving)return await new Promise(a=>setTimeout(a,100)),this.saveNow();this.isSaving=!0;try{let a=JSON.stringify(this.orderData,null,2),t=this.app.vault.adapter;if(await t.exists(this.viewDataFilePath))await t.write(this.viewDataFilePath,a);else{let i=this.viewDataFilePath.substring(0,this.viewDataFilePath.lastIndexOf("/"));i&&!await t.exists(i)&&await t.mkdir(i),await t.write(this.viewDataFilePath,a)}}catch(a){console.error("Failed to save order data:",a)}finally{this.isSaving=!1}}getFileOrder(){return this.orderData.files}async setFileOrder(a){this.orderData.files=a,await this.save()}getExpandedStates(a){var t;return(t=this.orderData.expandedStatesByFolder[a])!=null?t:{}}async setExpandedStates(a,t){this.orderData.expandedStatesByFolder[a]=t,await this.save()}async removeFolderData(a){this.orderData.expandedStatesByFolder[a]&&delete this.orderData.expandedStatesByFolder[a],await this.save()}async reorderH1InFile(a,t){let e=this.app.vault.getAbstractFileByPath(a);if(!(e instanceof E.TFile))return;let r=(await this.app.vault.read(e)).split(`
`),n=new Map,s=null,o=[],l=[],h=!0;for(let p of r){let u=p.trim();u.startsWith("# ")&&!u.startsWith("## ")?(s?n.set(s,o):h&&(l=o,h=!1),s=u.substring(2).trim(),o=[p]):o.push(p)}s&&n.set(s,o);let c=[...l];for(let p of t){let u=n.get(p);u&&c.push(...u)}let d=c.join(`
`);await this.app.vault.modify(e,d)}async reorderH2InFile(a,t,e){let i=this.app.vault.getAbstractFileByPath(a);if(!(i instanceof E.TFile))return;let n=(await this.app.vault.read(i)).split(`
`),s=-1,o=n.length,l=!1;for(let f=0;f<n.length;f++){let w=n[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")){if(y.substring(2).trim()===t)s=f,l=!0;else if(l){o=f;break}}}if(s===-1)return;let h=new Map,c=null,d=[],p=[],u=!0;for(let f=s;f<o;f++){let w=n[f];if(w===void 0)continue;let y=w.trim();if(f===s){p.push(w);continue}y.startsWith("## ")&&!y.startsWith("### ")?(c?h.set(c,d):u&&(p.push(...d),u=!1),c=y.substring(3).trim(),d=[w]):d.push(w)}c?h.set(c,d):d.length>0&&p.push(...d);let g=[...p];for(let f of e){let w=h.get(f);w&&g.push(...w)}let m=[...n.slice(0,s),...g,...n.slice(o)].join(`
`);await this.app.vault.modify(i,m)}async moveH1BetweenFiles(a,t,e,i,r=!1){let n=this.app.vault.getAbstractFileByPath(a);if(!(n instanceof E.TFile))return;let o=(await this.app.vault.read(n)).split(`
`),l=[],h=!1,c=!1;for(let f of o){let w=f.trim();if(w.startsWith("# ")&&!w.startsWith("## ")){if(w.substring(2).trim()===e)c=!0,h=!0,l.push(f);else if(c)break}else c&&l.push(f)}if(!h)return;let d=o.filter((f,w)=>{let y=f.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===e)return!1;let M=f;return!l.includes(M)});await this.app.vault.modify(n,d.join(`
`));let p=this.app.vault.getAbstractFileByPath(t);if(!(p instanceof E.TFile))return;let g=(await this.app.vault.read(p)).split(`
`),v=g.length;for(let f=0;f<g.length;f++){let w=g[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")&&y.substring(2).trim()===i){if(r)v=f;else for(let N=f+1;N<g.length;N++){let Q=g[N];if(!Q)continue;let G=Q.trim();if(G.startsWith("# ")&&!G.startsWith("## ")){v=N;break}}break}}let m=[...g.slice(0,v),...l,...g.slice(v)];await this.app.vault.modify(p,m.join(`
`))}async moveH1ToEndOfFile(a,t,e){if(a===t)return;let i=this.app.vault.getAbstractFileByPath(a);if(!(i instanceof E.TFile))return;let n=(await this.app.vault.read(i)).split(`
`),s=[],o=!1;for(let u of n){let g=u.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(g.substring(2).trim()===e){o=!0,s.push(u);continue}if(o)break}o&&s.push(u)}if(s.length===0)return;let l=[];o=!1;for(let u of n){let g=u.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(g.substring(2).trim()===e){o=!0;continue}o&&(o=!1)}o||l.push(u)}await this.app.vault.modify(i,l.join(`
`));let h=this.app.vault.getAbstractFileByPath(t);if(!(h instanceof E.TFile))return;let p=[...(await this.app.vault.read(h)).split(`
`),...s];await this.app.vault.modify(h,p.join(`
`))}async moveH2ToEndOfH1(a,t,e,i,r){let n=this.app.vault.getAbstractFileByPath(a);if(!(n instanceof E.TFile))return;let o=(await this.app.vault.read(n)).split(`
`),l=[],h=!1,c=!1;for(let f of o){let w=f.trim();if(w.startsWith("# ")&&!w.startsWith("## ")){if(h=w.substring(2).trim()===t,!h&&c)break;h||(c=!1)}else if(h&&w.startsWith("## ")&&!w.startsWith("### ")){if(w.substring(3).trim()===r)c=!0,l.push(f);else if(c)break}else c&&l.push(f)}if(l.length===0||a===e&&t===i)return;await this.removeH2FromFile(a,t,r);let d=this.app.vault.getAbstractFileByPath(e);if(!(d instanceof E.TFile))return;let u=(await this.app.vault.read(d)).split(`
`),g=u.length,v=!1;for(let f=0;f<u.length;f++){let w=u[f];if(!w)continue;let y=w.trim();if(y.startsWith("# ")&&!y.startsWith("## ")){if(y.substring(2).trim()===i)v=!0;else if(v){g=f;break}}}let m=[...u.slice(0,g),...l,...u.slice(g)];await this.app.vault.modify(d,m.join(`
`))}async moveH2BetweenH1s(a,t,e,i,r,n,s=!1){let o=this.app.vault.getAbstractFileByPath(a);if(!(o instanceof E.TFile))return;let h=(await this.app.vault.read(o)).split(`
`),c=[],d=!1,p=!1;for(let u of h){let g=u.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(d=g.substring(2).trim()===t,!d&&p)break}else if(d&&g.startsWith("## ")&&!g.startsWith("### ")){if(g.substring(3).trim()===r)p=!0,c.push(u);else if(p)break}else p&&c.push(u)}c.length!==0&&(await this.removeH2FromFile(a,t,r),await this.insertH2ToFile(e,i,n,c,s))}async removeH2FromFile(a,t,e){let i=this.app.vault.getAbstractFileByPath(a);if(!(i instanceof E.TFile))return;let n=(await this.app.vault.read(i)).split(`
`),s=[],o=!1,l=!1;for(let h of n){let c=h.trim();c.startsWith("# ")&&!c.startsWith("## ")?(o=c.substring(2).trim()===t,l=!1,s.push(h)):o&&c.startsWith("## ")&&!c.startsWith("### ")?c.substring(3).trim()===e?l=!0:(l=!1,s.push(h)):l||s.push(h)}await this.app.vault.modify(i,s.join(`
`))}async insertH2ToFile(a,t,e,i,r=!1){let n=this.app.vault.getAbstractFileByPath(a);if(!(n instanceof E.TFile))return;let o=(await this.app.vault.read(n)).split(`
`),l=o.length,h=!1,c=!1;for(let p=0;p<o.length;p++){let u=o[p];if(!u)continue;let g=u.trim();if(g.startsWith("# ")&&!g.startsWith("## ")){if(g.substring(2).trim()===t)h=!0;else if(h){l=p;break}}else if(h&&g.startsWith("## ")&&!g.startsWith("### ")&&g.substring(3).trim()===e)if(c=!0,r){l=p;break}else{for(let m=p+1;m<o.length;m++){let f=o[m];if(!f)continue;let w=f.trim();if(w.startsWith("## ")&&!w.startsWith("### ")){l=m;break}else if(w.startsWith("# ")&&!w.startsWith("## ")){l=m;break}}break}}let d=[...o.slice(0,l),...i,...o.slice(l)];await this.app.vault.modify(n,d.join(`
`))}};var C=require("obsidian"),T=require("@codemirror/view"),I=require("@codemirror/state"),$=class{constructor(a){this.keywordsCache=new Map;this.keywordPreviewCache=new Map;this.keywordGroupCache=new Map;this.keywordsVersion=0;this.previewEl=null;this.previewHoverKey="";this.previewAnchorEl=null;this.currentPreviewData=null;this.previewHideTimer=null;this.previewHideDelayMs=450;this.plugin=a,this.app=a.app,this.initializeHoverPreview(),this.plugin.register(()=>this.destroyHoverPreview())}getSettingFolderForFile(a){for(let t of this.plugin.settings.folderMappings)if(t.novelFolder&&t.settingFolder){let e=t.novelFolder.replace(/^\/+|\/+$/g,"");if(a.replace(/^\/+/,"").startsWith(e+"/"))return t.settingFolder}return null}async extractKeywordsFromSettingFolder(a){if(this.keywordsCache.has(a)&&this.keywordPreviewCache.has(a)&&this.keywordGroupCache.has(a))return this.keywordsCache.get(a);let t=new Set,e=new Map,i=new Map;if(!a)return t;let r=this.plugin.parser.getMarkdownFilesInFolder(a),n=await Promise.all(r.map(s=>this.plugin.parser.parseFile(s)));for(let s of n)if(s)for(let o of s.h1List)for(let l of o.h2List){let h=l.text.trim();if(h){let c=this.extractAliases(l.content),d=`h2::${s.filePath}::${o.text}::${l.text}`,p={keyword:h,filePath:s.filePath,fileName:s.fileName,h1Title:o.text,h2Title:l.text,status:this.extractPreferredStatus(l.content),aliases:c,bodyLines:this.extractBodyLines(l.content)};this.addKeywordVariant(t,e,i,h,p,d);for(let g of c)this.addKeywordVariant(t,e,i,g,p,d);let u=this.extractH3Sections(l.content);for(let g of u){if(!g.title)continue;let v=`h3::${s.filePath}::${o.text}::${l.text}::${g.title}`,m={keyword:g.title,filePath:s.filePath,fileName:s.fileName,h1Title:o.text,h2Title:l.text,status:g.status,aliases:g.aliases,bodyLines:g.bodyLines};this.addKeywordVariant(t,e,i,g.title,m,v);for(let f of g.aliases)this.addKeywordVariant(t,e,i,f,m,v)}}}return this.keywordsCache.set(a,t),this.keywordPreviewCache.set(a,e),this.keywordGroupCache.set(a,i),t}clearCache(){this.keywordsCache.clear(),this.keywordPreviewCache.clear(),this.keywordGroupCache.clear(),this.keywordsVersion++}getKeywordsVersion(){return this.keywordsVersion}refreshCurrentEditor(){this.clearCache();let a=this.app.workspace.getLeavesOfType("markdown");for(let t of a){let e=t.view;if(e instanceof C.MarkdownView&&e.editor){e.editor.refresh();let i=e.editor.cm;i&&i.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}}}getMarkdownViewForEditorView(a){let t=this.app.workspace.getLeavesOfType("markdown");for(let e of t){let i=e.view;if(!(i instanceof C.MarkdownView))continue;if(i.editor.cm===a)return i}return null}extractAliases(a){let t=[];for(let e of a){let i="\u3010\u522B\u540D\u3011",r=e.indexOf(i);if(r===-1)continue;let n=e.slice(r+i.length).trim();if(!n)continue;let s=n.split(/[,]/);for(let o of s){let l=o.trim();l&&t.push(l)}}return[...new Set(t)]}extractBodyLines(a){return a.map(t=>t.trim()).filter(t=>t.length>0).filter(t=>!/[^]+/.test(t)).map(t=>t.replace(/^[-*+]\s+/,"").trim()).filter(t=>t.length>0)}extractPreferredStatus(a){let t=[];for(let e of a){let i="\u3010\u72B6\u6001\u3011",r=e.indexOf(i);if(r===-1)continue;let n=e.slice(r+i.length).trim();if(!n)continue;let s=n.replace(/\s+/g," ").trim();s.includes("\u6B7B\u4EA1")&&t.push("\u6B7B\u4EA1"),s.includes("\u5931\u6548")&&t.push("\u5931\u6548");let o=s.split(/[,/|;]+/);for(let l of o){let h=l.trim();h&&t.push(h)}}if(t.length!==0)return t.includes("\u6B7B\u4EA1")?"\u6B7B\u4EA1":t.includes("\u5931\u6548")?"\u5931\u6548":t[0]}getKeywordPreview(a,t){var i;let e=this.keywordPreviewCache.get(a);return e&&(i=e.get(t))!=null?i:null}getKeywordGroupMap(a){var t;return(t=this.keywordGroupCache.get(a))!=null?t:new Map}addKeywordVariant(a,t,e,i,r,n){let s=i.trim();s&&(t.has(s)||(a.add(s),t.set(s,r),e.set(s,n)))}extractH3Sections(a){let t=[],e="",i=[],r=()=>{e&&t.push({title:e,status:this.extractPreferredStatus(i),aliases:this.extractAliases(i),bodyLines:this.extractBodyLines(i)})};for(let n of a){let s=n.trim();if(s.startsWith("### ")&&!s.startsWith("#### ")){r(),e=s.slice(4).trim(),i=[];continue}e&&i.push(n)}return r(),t}initializeHoverPreview(){this.previewEl=document.createElement("div"),this.previewEl.className="chinese-writer-highlight-preview",this.previewEl.style.display="none",document.body.appendChild(this.previewEl),this.plugin.registerDomEvent(this.previewEl,"mouseenter",()=>{this.clearScheduledHidePreview()}),this.plugin.registerDomEvent(this.previewEl,"mouseleave",()=>{this.scheduleHidePreview()}),this.plugin.registerDomEvent(document,"mousemove",a=>{this.handlePreviewHover(a)}),this.plugin.registerDomEvent(document,"mousedown",a=>{var r,n;let t=a.target;if(!t){this.hidePreview();return}let e=(n=(r=this.previewEl)==null?void 0:r.contains(t))!=null?n:!1,i=!!t.closest(".chinese-writer-highlight");!e&&!i&&this.hidePreview()}),this.plugin.registerDomEvent(document,"mouseleave",()=>this.scheduleHidePreview(120))}destroyHoverPreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.remove(),this.previewEl=null)}handlePreviewHover(a){var h,c;let t=a.target;if(!t){this.scheduleHidePreview();return}if((c=(h=this.previewEl)==null?void 0:h.contains(t))!=null?c:!1){this.clearScheduledHidePreview();return}let i=t.closest(".cw-tree-preview-anchor");if(i){if(!this.plugin.settings.enableTreeH2HoverPreview){this.scheduleHidePreview(80);return}this.clearScheduledHidePreview(),this.showPreviewForTreeNodeAnchor(i,a.clientX,a.clientY);return}let r=t.closest(".chinese-writer-highlight");if(!r){this.scheduleHidePreview();return}if(!this.plugin.settings.enableEditorHoverPreview){this.scheduleHidePreview(80);return}let n=r.dataset.cwKeyword,s=r.dataset.cwSettingFolder;if(!n||!s){this.scheduleHidePreview();return}let o=this.getKeywordPreview(s,n);if(!o){this.scheduleHidePreview();return}this.clearScheduledHidePreview();let l=`${s}::${n}`;this.showPreview(o,l,r,a.clientX,a.clientY)}async showPreviewForTreeNodeAnchor(a,t,e){var c;let i=a.dataset.cwTreeSettingFolder,r=a.dataset.cwTreeFilePath,n=a.dataset.cwTreeH1,s=a.dataset.cwTreeH2,o=(c=a.dataset.cwTreeKeyword)!=null?c:s;if(!i||!r||!n||!s||!o){this.scheduleHidePreview(120);return}await this.extractKeywordsFromSettingFolder(i);let l=this.findTreeNodePreviewData(i,r,n,s,o);if(!l){this.scheduleHidePreview(120);return}this.clearScheduledHidePreview();let h=`tree::${r}::${n}::${s}`;this.showPreview(l,h,a,t,e)}findTreeNodePreviewData(a,t,e,i,r){var s;let n=this.keywordPreviewCache.get(a);if(!n)return null;for(let o of n.values())if(o.filePath===t&&o.h1Title===e&&o.h2Title===i)return o;return(s=n.get(r))!=null?s:null}showPreview(a,t,e,i,r){if(!this.previewEl)return;let n=this.previewHoverKey!==t,s=this.previewAnchorEl!==e;if(n){this.previewEl.empty();let l=this.previewEl.createDiv({cls:"cw-preview-header"}),h=l.createDiv({cls:"cw-preview-header-main"}),c=h.createDiv({cls:"cw-preview-title"}),d=a.status?`${a.keyword}[${a.status}]`:a.keyword;c.setText(d),h.createDiv({cls:"cw-preview-location"}).setText(`${a.fileName}/${a.h1Title}`);let u=l.createDiv({cls:"cw-preview-actions"}),g=u.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u641C\u7D22",title:"\u641C\u7D22"}});(0,C.setIcon)(g,"search"),g.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openGlobalSearch(a.keyword)});let v=u.createEl("button",{cls:"cw-preview-btn",attr:{"aria-label":"\u7F16\u8F91",title:"\u7F16\u8F91"}});(0,C.setIcon)(v,"pen"),v.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),await this.openKeywordSource(a)}),a.aliases.length>0&&(this.previewEl.createDiv({cls:"cw-preview-blank-line"}).setText(" "),this.previewEl.createDiv({cls:"cw-preview-label"}).setText("\u522B\u540D"),this.previewEl.createDiv({cls:"cw-preview-aliases"}).setText(a.aliases.join(" "))),this.previewEl.createDiv({cls:"cw-preview-divider"});let m=this.previewEl.createDiv({cls:"cw-preview-body"});if(a.bodyLines.length===0)m.createDiv({cls:"cw-preview-empty",text:"\uFF08\u65E0\u8BBE\u5B9A\u5185\u5BB9\uFF09"});else{let f=m.createEl("ul",{cls:"cw-preview-list"});for(let w of a.bodyLines)f.createEl("li",{cls:"cw-preview-line"}).setText(w)}this.previewHoverKey=t,this.previewAnchorEl=e,this.currentPreviewData=a}let o=this.plugin.settings.highlightPreviewStyle;if(this.previewEl.style.width=`${o.width}px`,this.previewEl.style.maxHeight=`${o.height}px`,this.previewEl.style.setProperty("--cw-preview-max-lines",String(o.maxBodyLines)),this.previewEl.style.display="flex",this.applyBodyMaxHeight(o.height,o.maxBodyLines),n||s){this.previewAnchorEl=e;let l=14,h=i+l,c=r+l,d=this.previewEl.getBoundingClientRect();h+d.width>window.innerWidth-8&&(h=Math.max(8,i-d.width-l)),c+d.height>window.innerHeight-8&&(c=Math.max(8,r-d.height-l)),this.previewEl.style.left=`${h}px`,this.previewEl.style.top=`${c}px`}}hidePreview(){this.clearScheduledHidePreview(),this.previewEl&&(this.previewEl.style.display="none",this.previewHoverKey="",this.previewAnchorEl=null,this.currentPreviewData=null)}scheduleHidePreview(a=this.previewHideDelayMs){this.clearScheduledHidePreview(),this.previewHideTimer=window.setTimeout(()=>{this.hidePreview()},a)}clearScheduledHidePreview(){this.previewHideTimer!==null&&(window.clearTimeout(this.previewHideTimer),this.previewHideTimer=null)}applyBodyMaxHeight(a,t){if(!this.previewEl)return;let e=this.previewEl.querySelector(".cw-preview-body");if(!e)return;let r=Math.max(40,t*21),n=Math.max(0,this.previewEl.offsetHeight-e.offsetHeight),s=Math.max(40,a-n-4),o=Math.min(r,s);e.style.maxHeight=`${o}px`}async openGlobalSearch(a){let t=a.trim();if(!t)return;let e=this.app.commands;e&&await e.executeCommandById("global-search:open"),window.setTimeout(()=>{var o;let i=this.app.workspace.getLeavesOfType("search");if(i.length===0)return;let r=(o=i[0])==null?void 0:o.view,n=r==null?void 0:r.containerEl;if(!n)return;let s=n.querySelector("input");s&&(s.value=t,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),s.focus())},80)}async openKeywordSource(a){let t=this.app.vault.getAbstractFileByPath(a.filePath);if(!(t instanceof C.TFile))return;let i=(await this.app.vault.read(t)).split(`
`),r=this.findFirstContentLine(i,a.h1Title,a.h2Title),n=await this.plugin.openFileWithSettings(t,{revealWhenNewTab:!0});if(!n)return;let s=n.view instanceof C.MarkdownView?n.view:null;s!=null&&s.editor&&(s.editor.setCursor({line:r,ch:0}),this.centerEditorLine(s.editor,r),this.hidePreview())}centerEditorLine(a,t){let e=a.cm;if(!e)return;let i=Math.max(0,Math.min(t,e.state.doc.lines-1)),r=e.state.doc.line(i+1).from,n=()=>{e.dispatch({effects:T.EditorView.scrollIntoView(r,{y:"center",yMargin:0})})};n(),window.setTimeout(n,30)}findFirstContentLine(a,t,e){var s,o;let i=!1,r=!1,n=0;for(let l=0;l<a.length;l++){let h=(o=(s=a[l])==null?void 0:s.trim())!=null?o:"";if(h.startsWith("# ")&&!h.startsWith("## ")){i=h.slice(2).trim()===t,r=!1;continue}if(i&&h.startsWith("## ")&&!h.startsWith("### ")){r=h.slice(3).trim()===e,r&&(n=l);continue}if(r){if(h.startsWith("#"))break;if(h.length>0)return l}}return n}isFileInFolder(a,t){let e=t.replace(/^\/+|\/+$/g,""),i=a.replace(/^\/+/,"");return e?i.startsWith(e+"/"):!1}collectPunctuationWarnings(a){var i,r;let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return[];let e=new Set;for(let n=0;n<a.length;n++){let s=a[n];if(t.comma&&s===","&&e.add(n),t.period&&s==="."){let o=n>0&&(i=a[n-1])!=null?i:"",l=n+1<a.length&&(r=a[n+1])!=null?r:"";/\d/.test(o)&&/\d/.test(l)||e.add(n)}t.colon&&s===":"&&e.add(n),t.semicolon&&s===";"&&e.add(n),t.exclamation&&s==="!"&&e.add(n),t.question&&s==="?"&&e.add(n),t.doubleQuote&&s==='"'&&e.add(n),t.singleQuote&&s==="'"&&e.add(n)}if(t.doubleQuote){let n=[];for(let s=0;s<a.length;s++){let o=a[s];o==="\u201C"?n.push(s):o==="\u201D"&&(n.length>0?n.pop():e.add(s))}for(let s of n)e.add(s)}if(t.singleQuote){let n=[];for(let s=0;s<a.length;s++){let o=a[s];o==="\u2018"?n.push(s):o==="\u2019"&&(n.length>0?n.pop():e.add(s))}for(let s of n)e.add(s)}return Array.from(e).sort((n,s)=>n-s)}async fixPunctuationForActiveEditor(){let a=this.app.workspace.getActiveViewOfType(C.MarkdownView);if(!(a!=null&&a.file)||!a.editor)return;let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return;let e=this.getSettingFolderForFile(a.file.path);if(!e||this.isFileInFolder(a.file.path,e))return;let i=a.editor.getValue(),{text:r,changedCount:n}=this.applyPunctuationFixes(i);n<=0||r===i||(a.editor.setValue(r),this.refreshCurrentEditor())}applyPunctuationFixes(a){let t=this.plugin.settings.punctuationCheck;if(!(t!=null&&t.enabled))return{text:a,changedCount:0};let e=a,i=0,r=(n,s,o)=>{var c;let l=0,h=n.split("");for(let d=0;d<h.length;d++){let p=(c=h[d])!=null?c:"";s(p,d,n)&&p!==o&&(h[d]=o,l++)}return{text:h.join(""),count:l}};if(t.comma){let n=r(e,s=>s===",","\uFF0C");e=n.text,i+=n.count}if(t.period){let n=r(e,(s,o,l)=>{var p,u;if(s!==".")return!1;let h=o>0&&(p=l[o-1])!=null?p:"",c=o+1<l.length&&(u=l[o+1])!=null?u:"";return!(/\d/.test(h)&&/\d/.test(c))},"\u3002");e=n.text,i+=n.count}if(t.semicolon){let n=r(e,s=>s===";","\uFF1B");e=n.text,i+=n.count}if(t.exclamation){let n=r(e,s=>s==="!","\uFF01");e=n.text,i+=n.count}if(t.question){let n=r(e,s=>s==="?","\uFF1F");e=n.text,i+=n.count}if(t.colon){let n=r(e,s=>s===":","\uFF1A");e=n.text,i+=n.count}if(t.doubleQuote){let n=this.normalizeQuotePairs(e,new Set(['"',"\u201C","\u201D"]),"\u201C","\u201D");e=n.text,i+=n.count}if(t.singleQuote){let n=this.normalizeQuotePairs(e,new Set(["'","\u2018","\u2019"]),"\u2018","\u2019");e=n.text,i+=n.count}return{text:e,changedCount:i}}normalizeQuotePairs(a,t,e,i){var o;let r=!0,n=0,s=a.split("");for(let l=0;l<s.length;l++){let h=(o=s[l])!=null?o:"";if(!t.has(h))continue;let c=r?e:i;h!==c&&(s[l]=c,n++),r=!r}return{text:s.join(""),count:n}}createEditorExtension(){let a=this;return T.ViewPlugin.fromClass(class{constructor(t){this.decorations=T.Decoration.none;this.currentFile=null;this.keywordsVersionSeen=-1;this.updateRunId=0;this.keywordsVersionSeen=a.getKeywordsVersion(),this.updateDecorations(t)}async updateDecorations(t){let e=++this.updateRunId,i=a.getMarkdownViewForEditorView(t);if(!i||!i.file){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}let r=i.file;this.currentFile=r,this.keywordsVersionSeen=a.getKeywordsVersion();let n=a.getSettingFolderForFile(r.path);if(!n){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}if(a.isFileInFolder(r.path,n)){e===this.updateRunId&&(this.decorations=T.Decoration.none);return}let s=await a.extractKeywordsFromSettingFolder(n);if(e!==this.updateRunId)return;let o=new I.RangeSetBuilder,h=t.state.doc.toString(),c=[],d=a.getKeywordGroupMap(n),p=a.plugin.settings.highlightStyle.mode;for(let m of s){let f=m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),w=new RegExp(f,"g"),y;for(;(y=w.exec(h))!==null;)c.push({from:y.index,to:y.index+m.length,keyword:m})}let u=p==="first"?(()=>{var w;let m=new Map,f=[...c].sort((y,M)=>y.from-M.from);for(let y of f){let M=(w=d.get(y.keyword))!=null?w:`kw::${y.keyword}`;m.has(M)||m.set(M,y)}return Array.from(m.values())})():c,g=[];u.sort((m,f)=>m.from-f.from);for(let m of u)g.push({from:m.from,to:m.to,decoration:T.Decoration.mark({class:"chinese-writer-highlight",attributes:{"data-cw-keyword":m.keyword,"data-cw-setting-folder":n}})});let v=a.collectPunctuationWarnings(h);for(let m of v)g.push({from:m,to:m+1,decoration:T.Decoration.mark({class:"chinese-writer-punctuation-warning"})});g.sort((m,f)=>m.from!==f.from?m.from-f.from:m.to-f.to);for(let m of g)o.add(m.from,m.to,m.decoration);this.decorations=o.finish(),t.dispatch({annotations:I.Transaction.addToHistory.of(!1)})}update(t){var o,l,h,c;let e=this.keywordsVersionSeen!==a.getKeywordsVersion(),i=a.getMarkdownViewForEditorView(t.view),r=(l=(o=i==null?void 0:i.file)==null?void 0:o.path)!=null?l:null,n=(c=(h=this.currentFile)==null?void 0:h.path)!=null?c:null,s=r!==n;(t.docChanged||e||s)&&this.updateDecorations(t.view)}destroy(){}},{decorations:t=>t.decorations})}updateStyles(){let a=this.plugin.settings.highlightStyle,t=a.borderWidth>0?"underline":"none",e=document.getElementById("chinese-writer-highlight-style");e&&e.remove();let i=document.createElement("style");i.id="chinese-writer-highlight-style",i.textContent=`
      .chinese-writer-highlight {
        background-color: ${a.backgroundColor};
        text-decoration-line: ${t} !important;
        text-decoration-style: ${a.borderStyle} !important;
        text-decoration-color: ${a.borderColor} !important;
        text-decoration-thickness: ${a.borderWidth}px !important;
        text-underline-offset: 8px !important;
        text-decoration-skip-ink: none !important;
        font-weight: ${a.fontWeight};
        font-style: ${a.fontStyle};
        color: ${a.color};
      }
    `,document.head.appendChild(i)}};var R=class{constructor(a){this.plugin=a}updateStyles(){var n,s,o;let a=document.getElementById("chinese-writer-editor-typography-style");if(a&&a.remove(),!this.plugin.settings.enableEditorTypography)return;let t=Math.max(0,(n=this.plugin.settings.editorIndentCjkChars)!=null?n:0),e=Math.max(1,(s=this.plugin.settings.editorLineHeight)!=null?s:1.8),i=Math.max(0,(o=this.plugin.settings.editorParagraphSpacing)!=null?o:0),r=document.createElement("style");r.id="chinese-writer-editor-typography-style",r.textContent=`
      .markdown-source-view.mod-cm6 .cm-line {
        line-height: ${e};
      }

      .markdown-source-view.mod-cm6 .cm-line:not(.HyperMD-codeblock):not(.HyperMD-header):not(.HyperMD-list-line):not(.HyperMD-quote) {
        text-indent: calc(${t} * 1em);
        padding-top: calc(${i}px / 2);
        padding-bottom: calc(${i}px / 2);
        box-sizing: border-box;
      }
    `,document.head.appendChild(r)}};var B=require("obsidian"),X=require("@codemirror/view"),j=class{constructor(a){this.fileCharCache=new Map;this.folderStatsCache=new Map;this.refreshTimer=null;this.mutationObserver=null;this.statusBarEl=null;this.statusUpdateRunId=0;this.plugin=a}setup(){this.setEnabled(this.isEnabled())}destroy(){this.stopRuntime(),this.clearFileExplorerBadges()}createSelectionListenerExtension(){return X.EditorView.updateListener.of(a=>{this.isEnabled()&&(!a.docChanged&&!a.selectionSet||this.handleEditorRealtimeUpdate(a))})}setEnabled(a){if(a){this.startRuntime();return}this.stopRuntime(),this.clearFileExplorerBadges()}onVaultFileChanged(a){this.isEnabled()&&(a&&this.fileCharCache.delete(a),this.folderStatsCache.clear(),this.scheduleFileExplorerRefresh(),this.updateStatusBar())}onActiveLeafChanged(){this.isEnabled()&&this.updateStatusBar()}isEnabled(){return!!this.plugin.settings.enableMdStats}startRuntime(){this.statusBarEl||(this.statusBarEl=this.plugin.addStatusBarItem(),this.statusBarEl.addClass("cw-status-char-counter")),this.updateStatusBar(),this.startFileExplorerObserver(),this.scheduleFileExplorerRefresh()}stopRuntime(){var a;this.refreshTimer!==null&&(window.clearTimeout(this.refreshTimer),this.refreshTimer=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),(a=this.statusBarEl)==null||a.remove(),this.statusBarEl=null}clearFileExplorerBadges(){let a=".cw-folder-md-stats, .cw-file-md-stats";for(let t of Array.from(document.querySelectorAll(a)))t instanceof HTMLElement&&t.remove()}scheduleFileExplorerRefresh(){this.refreshTimer!==null&&window.clearTimeout(this.refreshTimer),this.refreshTimer=window.setTimeout(()=>{this.refreshTimer=null,this.renderFileExplorerStats()},120)}startFileExplorerObserver(){var a;(a=this.mutationObserver)==null||a.disconnect(),this.mutationObserver=new MutationObserver(()=>{this.scheduleFileExplorerRefresh()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-path"]})}async renderFileExplorerStats(){var e;let a=this.getFileExplorerFolderTitleElements(),t=this.getFileExplorerFileTitleElements();if(!(a.length===0&&t.length===0)){for(let i of a){let r=((e=i.getAttribute("data-path"))!=null?e:"").trim(),n=await this.getFolderStats(r);this.renderFolderStatsBadge(i,n)}for(let i of t)await this.renderFileStatsBadge(i)}}handleEditorRealtimeUpdate(a){let t=this.getMarkdownViewForEditorView(a.view),e=t==null?void 0:t.file;if(!t||!e||e.extension!=="md"){this.updateStatusBar();return}let i=a.state.doc.toString(),r=this.countMarkdownCharacters(i),n=this.countMarkdownCharacters(this.getSelectedTextFromState(a.state));if(this.setStatusBarText(r,n),a.docChanged){let s=this.countMarkdownCharacters(a.startState.doc.toString()),o=r-s;this.fileCharCache.set(e.path,{mtime:e.stat.mtime,size:e.stat.size,count:r}),o!==0&&(this.applyFolderStatsDelta(e.path,o),this.renderVisibleFolderBadgesByPaths(this.getAncestorFolderPaths(e.path))),this.renderVisibleFileBadgeByPath(e.path,r)}}getSelectedTextFromState(a){let t=[];for(let e of a.selection.ranges)e.empty||t.push(a.doc.sliceString(e.from,e.to));return t.join("")}getMarkdownViewForEditorView(a){let t=this.plugin.app.workspace.getLeavesOfType("markdown");for(let e of t){let i=e.view;if(!(i instanceof B.MarkdownView))continue;if(i.editor.cm===a)return i}return null}renderVisibleFileBadgeByPath(a,t){var i;let e=this.getFileExplorerFileTitleElements();for(let r of e){if(((i=r.getAttribute("data-path"))!=null?i:"")!==a)continue;let n=`${this.formatCharCount(t)}`,s=r.querySelector(".cw-file-md-stats");s||(s=r.createSpan({cls:"cw-file-md-stats"})),s.setText(n);return}}renderVisibleFolderBadgesByPaths(a){var i;let t=new Set(a),e=this.getFileExplorerFolderTitleElements();for(let r of e){let n=((i=r.getAttribute("data-path"))!=null?i:"").trim();if(!t.has(n))continue;let s=this.folderStatsCache.get(n);s&&this.renderFolderStatsBadge(r,s)}}applyFolderStatsDelta(a,t){if(t===0)return;let e=this.getAncestorFolderPaths(a);for(let i of e){let r=this.folderStatsCache.get(i);r&&(r.charCount=Math.max(0,r.charCount+t),this.folderStatsCache.set(i,r))}}getAncestorFolderPaths(a){var n;let e=a.replace(/^\/+|\/+$/g,"").split("/");if(e.length<=1)return[""];let i=[""],r="";for(let s=0;s<e.length-1;s++)r=r?`${r}/${e[s]}`:(n=e[s])!=null?n:"",r&&i.push(r);return i}getFileExplorerFolderTitleElements(){return Array.from(document.querySelectorAll('.workspace-leaf-content[data-type="file-explorer"] .nav-folder-title[data-path]')).filter(t=>t instanceof HTMLElement)}getFileExplorerFileTitleElements(){return Array.from(document.querySelectorAll('.workspace-leaf-content[data-type="file-explorer"] .nav-file-title[data-path]')).filter(t=>t instanceof HTMLElement)}renderFolderStatsBadge(a,t){let e=`${t.fileCount}\u7AE0 | ${this.formatCharCount(t.charCount)}`,i=a.querySelector(".cw-folder-md-stats");i||(i=a.createSpan({cls:"cw-folder-md-stats"})),i.setText(e)}async renderFileStatsBadge(a){var s;let t=((s=a.getAttribute("data-path"))!=null?s:"").trim(),e=this.plugin.app.vault.getAbstractFileByPath(t);if(!(e instanceof B.TFile)||e.extension!=="md"){let o=a.querySelector(".cw-file-md-stats");o==null||o.remove();return}let i=await this.getFileCharCount(e),r=`${this.formatCharCount(i)}`,n=a.querySelector(".cw-file-md-stats");n||(n=a.createSpan({cls:"cw-file-md-stats"})),n.setText(r)}async getFolderStats(a){let t=this.folderStatsCache.get(a);if(t)return t;let e=this.plugin.app.vault.getMarkdownFiles().filter(n=>a===""?!0:n.path.startsWith(`${a}/`)),i=0;for(let n of e)i+=await this.getFileCharCount(n);let r={fileCount:e.length,charCount:i};return this.folderStatsCache.set(a,r),r}async getFileCharCount(a){let t=this.fileCharCache.get(a.path);if(t&&t.mtime===a.stat.mtime&&t.size===a.stat.size)return t.count;let e=await this.plugin.app.vault.read(a),i=this.countMarkdownCharacters(e);return this.fileCharCache.set(a.path,{mtime:a.stat.mtime,size:a.stat.size,count:i}),i}countMarkdownCharacters(a){return this.stripFrontmatter(a).split(`
`).map(r=>r.replace(/^\s{0,3}#{1,6}\s+/,"")).join("").replace(/[\s-]+/g,"").length}stripFrontmatter(a){var i,r;let t=a.replace(/\r\n/g,`
`),e=t.split(`
`);if(((i=e[0])!=null?i:"").trim()!=="---")return t;for(let n=1;n<e.length;n++)if(((r=e[n])!=null?r:"").trim()==="---")return e.slice(n+1).join(`
`);return t}formatCharCount(a){return a<1e3?`${a}\u5B57`:a<1e4?`${(a/1e3).toFixed(1)}\u5343`:`${(a/1e4).toFixed(1)}\u4E07`}async updateStatusBar(){let a=++this.statusUpdateRunId,t=await this.buildStatusBarText();a===this.statusUpdateRunId&&this.statusBarEl&&this.statusBarEl.setText(t)}async buildStatusBarText(){var n,s;let a=this.plugin.app.workspace.getActiveViewOfType(B.MarkdownView),t=a==null?void 0:a.file;if(!t||t.extension!=="md")return"";let e=await this.getFileCharCount(t),i=(s=(n=a.editor)==null?void 0:n.getSelection())!=null?s:"",r=i?this.countMarkdownCharacters(i):0;return this.buildStatusText(e,r)}setStatusBarText(a,t){this.statusBarEl&&this.statusBarEl.setText(this.buildStatusText(a,t))}buildStatusText(a,t){return t>0?`${t}\u5B57 / ${a}\u5B57`:`${a}\u5B57`}};var K=class extends S.Plugin{constructor(){super(...arguments);this.pluginDir="";this.settingsFilePath="";this.settingMenuRootEl=null;this.settingMenuChildEl=null;this.settingMenuCloseTimer=null;this.settingMenuExpandDirection="right";this.h3TitleCacheByFolder=new Map}async onload(){this.pluginDir=await this.resolvePluginDir(),this.settingsFilePath=`${this.pluginDir}/cw-setting.json`,await this.loadSettings(),this.parser=new A(this.app.vault),this.orderManager=new V(this.app,this.pluginDir),await this.orderManager.load(),await this.rebuildAllH3TitleCache(),this.highlightManager=new $(this),this.editorTypographyManager=new R(this),this.mdStatsManager=new j(this),this.registerEditorExtension(this.highlightManager.createEditorExtension()),this.registerEditorExtension(this.mdStatsManager.createSelectionListenerExtension()),this.highlightManager.updateStyles(),this.editorTypographyManager.updateStyles(),this.mdStatsManager.setup(),this.registerView(H,t=>new D(t,this)),this.addCommand({id:"open-tree-view",name:"\u6253\u5F00\u6587\u6863\u6811\u89C6\u56FE",callback:()=>{this.activateView()}}),this.addCommand({id:"auto-fix-punctuation-in-current-file",name:"\u81EA\u52A8\u4FEE\u6B63\u5F53\u524D\u6587\u6863\u6807\u70B9\u95EE\u9898",callback:async()=>{await this.highlightManager.fixPunctuationForActiveEditor()}}),this.addRibbonIcon("book-type","\u4E2D\u6587\u5199\u4F5C",()=>{this.activateView()}),this.addSettingTab(new W(this.app,this)),this.register(()=>this.closeSettingSubmenus()),this.registerEvent(this.app.workspace.on("editor-menu",(t,e,i)=>{this.appendAddSettingEditorMenu(t,e,i)})),this.app.workspace.onLayoutReady(()=>{setTimeout(()=>{let t=this.app.workspace.getActiveViewOfType(S.MarkdownView);t&&t.file&&this.highlightManager.refreshCurrentEditor()},100)}),this.registerEvent(this.app.vault.on("modify",t=>{if(t instanceof S.TFile&&t.extension==="md"){this.mdStatsManager.onVaultFileChanged(t.path),this.smartUpdateView(),this.updateH3CacheForSettingFile(t.path);for(let e of this.settings.folderMappings)if(e.settingFolder&&t.path.startsWith(e.settingFolder+"/")){this.highlightManager.clearCache(),setTimeout(()=>{this.highlightManager.refreshCurrentEditor()},100);break}}})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof S.TFile&&t.extension==="md"&&(this.mdStatsManager.onVaultFileChanged(t.path),this.syncOrderOnFileCreate(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof S.TFile&&t.extension==="md"&&(this.mdStatsManager.onVaultFileChanged(t.path),this.syncOrderOnFileDelete(t),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof S.TFile&&t.extension==="md"&&(this.mdStatsManager.onVaultFileChanged(e),this.mdStatsManager.onVaultFileChanged(t.path),this.syncOrderOnFileRename(t,e),this.updateH3CacheForSettingFile(e),this.updateH3CacheForSettingFile(t.path))})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.mdStatsManager.onActiveLeafChanged()})),this.app.workspace.onLayoutReady(()=>{this.activateView()})}onunload(){this.app.workspace.detachLeavesOfType(H),this.mdStatsManager.destroy()}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(H)[0];if(!e){let i=t.getRightLeaf(!1);i&&(await i.setViewState({type:H,active:!0}),e=i)}e&&t.revealLeaf(e)}async refreshView(){let t=this.app.workspace.getLeavesOfType(H);for(let e of t){let i=e.view;i instanceof D&&await i.refresh()}}async smartUpdateView(){let t=this.app.workspace.getLeavesOfType(H);for(let e of t){let i=e.view;i instanceof D&&await i.smartUpdate()}}async loadSettings(){let t=await this.readSettingsData();this.settings=Object.assign({},L,t),this.settings.highlightStyle&&(this.settings.highlightStyle=Object.assign({},L.highlightStyle,this.settings.highlightStyle)),this.settings.highlightPreviewStyle?this.settings.highlightPreviewStyle=Object.assign({},L.highlightPreviewStyle,this.settings.highlightPreviewStyle):this.settings.highlightPreviewStyle=Object.assign({},L.highlightPreviewStyle),this.settings.punctuationCheck?this.settings.punctuationCheck=Object.assign({},L.punctuationCheck,this.settings.punctuationCheck):this.settings.punctuationCheck=Object.assign({},L.punctuationCheck);let e=t==null?void 0:t.openInCurrentTab;!(typeof(t==null?void 0:t.openInNewTab)=="boolean")&&typeof e=="boolean"&&(this.settings.openInNewTab=!e),t&&t.targetFolder&&this.settings.folderMappings.length===0&&console.log("\u68C0\u6D4B\u5230\u65E7\u7248\u672C\u914D\u7F6E\uFF0C\u5DF2\u5220\u9664 targetFolder \u5B57\u6BB5\u3002\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u65B0\u7684\u6587\u4EF6\u5939\u5BF9\u5E94\u5173\u7CFB\u3002")}async saveSettings(){let t=this.app.vault.adapter,e=this.settingsFilePath.substring(0,this.settingsFilePath.lastIndexOf("/"));e&&!await t.exists(e)&&await t.mkdir(e),await t.write(this.settingsFilePath,JSON.stringify(this.settings,null,2))}async resolvePluginDir(){var s,o,l;let t=this.app.vault.adapter,e=(s=this.manifest.dir)==null?void 0:s.trim(),i=(l=(o=this.manifest.id)==null?void 0:o.trim())!=null?l:"",r=i.toLowerCase(),n=Array.from(new Set([e,i?`.obsidian/plugins/${i}`:null,r?`.obsidian/plugins/${r}`:null].filter(h=>!!h&&h.length>0)));for(let h of n)if(await t.exists(`${h}/cw-setting.json`)||await t.exists(`${h}/cw-view-datas.json`)||await t.exists(`${h}/settings.json`)||await t.exists(`${h}/data.json`)||await t.exists(`${h}/view-datas.json`)||await t.exists(`${h}/order.json`))return h;for(let h of n)if(await t.exists(h))return h;return e&&e.length>0?e:`.obsidian/plugins/${r||"chinese-writer"}`}async readSettingsData(){let t=this.app.vault.adapter,e=`${this.pluginDir}/cw-setting.json`,i=`${this.pluginDir}/settings.json`,r=`${this.pluginDir}/data.json`;try{if(await t.exists(e)){let n=await t.read(e),s=JSON.parse(n);return s&&typeof s=="object"?s:{}}if(await t.exists(i)){let n=await t.read(i),s=JSON.parse(n);return s&&typeof s=="object"?s:{}}if(await t.exists(r)){let n=await t.read(r),s=JSON.parse(n);return s&&typeof s=="object"?s:{}}}catch(n){console.error("Failed to read settings data:",n)}return{}}async openFileWithSettings(t,e){var o;let i=this.settings.openInNewTab,r=(o=e==null?void 0:e.revealWhenNewTab)!=null?o:!1,n=this.findOpenedLeafForFile(t.path);if(n)return(!i||r)&&this.app.workspace.revealLeaf(n),n;if(!i){let l=this.getPreferredCurrentLeaf();return l?(await l.openFile(t,{active:!0}),l):null}let s=this.app.workspace.getLeaf("tab");return await s.openFile(t,{active:r}),s}getPreferredCurrentLeaf(){let t=this.app.workspace.getActiveViewOfType(S.MarkdownView);if(t)return t.leaf;let e=this.app.workspace.getLeavesOfType("markdown");return e.length>0?e[0]:this.app.workspace.getMostRecentLeaf()}findOpenedLeafForFile(t){var i,r;let e=this.app.workspace.getLeavesOfType("markdown");for(let n of e){let s=n.getViewState();if((typeof((i=s.state)==null?void 0:i.file)=="string"?s.state.file:null)===t)return n;let l=n.view;if(l instanceof S.MarkdownView&&((r=l.file)==null?void 0:r.path)===t)return n}return null}appendAddSettingEditorMenu(t,e,i){var l;let n=e.getSelection().replace(/\s+/g," ").trim();if(!n)return;let s=(l=i==null?void 0:i.file)!=null?l:this.app.workspace.getActiveFile();if(!(s instanceof S.TFile))return;let o=this.highlightManager.getSettingFolderForFile(s.path);o&&(this.hasH3InSettingFolder(o,n)||(t.addSeparator(),t.addItem(h=>{h.setTitle("\u6DFB\u52A0\u8BBE\u5B9A"),h.setIcon("book-plus"),h.onClick(d=>{this.openSettingFirstLevelMenu(d.clientX,d.clientY,o,n,null)});let c=h==null?void 0:h.dom;if(c){let d=c.createSpan({cls:"cw-context-submenu-arrow"});(0,S.setIcon)(d,"chevron-right"),c.addEventListener("mouseenter",()=>{let p=c.getBoundingClientRect();this.openSettingFirstLevelMenu(p.right-2,p.top,o,n,p)}),c.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}})))}async collectSettingFileOptions(t){let e=this.parser.getMarkdownFilesInFolder(t),i=this.orderManager.getFileOrder(),r=[...e].sort((s,o)=>{let l=i.indexOf(s.path),h=i.indexOf(o.path);return l===-1&&h===-1?s.path.localeCompare(o.path):l===-1?1:h===-1?-1:l-h}),n=[];for(let s of r){let o=await this.parser.parseFile(s);if(!o)continue;let l=[];for(let h of o.h1List)l.push({label:h.text,lineNumber:h.lineNumber});n.push({file:s,h1Options:l})}return n}async openSettingFirstLevelMenu(t,e,i,r,n){this.clearCloseSettingSubmenusTimer();let s=await this.collectSettingFileOptions(i);if(s.length===0){this.closeSettingSubmenus(),new S.Notice("\u8BE5\u8BBE\u5B9A\u5E93\u6CA1\u6709\u53EF\u7528\u7684 H1 \u9009\u9879");return}this.settingMenuRootEl||(this.settingMenuRootEl=this.createSettingSubmenuContainer("cw-setting-submenu-root")),this.settingMenuRootEl.empty(),this.settingMenuRootEl.removeClass("is-expand-left"),this.settingMenuRootEl.removeClass("is-expand-right");let o=[];for(let c of s){let d=this.settingMenuRootEl.createDiv({cls:"cw-setting-submenu-item"}),p=d.createSpan({cls:"cw-setting-submenu-item-icon"});(0,S.setIcon)(p,"file-text"),d.createSpan({text:c.file.basename,cls:"cw-setting-submenu-label"});let u=c.h1Options.length>0,g=d.createSpan({cls:"cw-setting-submenu-item-arrow"});(0,S.setIcon)(g,"chevron-right"),o.push({el:g,hasChildren:u}),u||d.addClass("is-disabled"),d.addEventListener("mouseenter",()=>{if(this.clearCloseSettingSubmenusTimer(),u){let v=d.getBoundingClientRect();this.openSettingSecondLevelMenu(v,c,r)}else this.closeSettingChildMenu()}),d.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus())}let l=n!=null?n:this.createPointAnchorRect(t,e);this.settingMenuExpandDirection=this.pickMenuExpandDirection(this.settingMenuRootEl,l);let h=this.settingMenuExpandDirection==="left";this.settingMenuRootEl.toggleClass("is-expand-left",h),this.settingMenuRootEl.toggleClass("is-expand-right",!h);for(let c of o)c.hasChildren&&(c.el.empty(),(0,S.setIcon)(c.el,h?"chevron-left":"chevron-right"));n?this.placeMenuBesideAnchor(this.settingMenuRootEl,n,2,this.settingMenuExpandDirection):this.placeMenuBesideAnchor(this.settingMenuRootEl,l,2,this.settingMenuExpandDirection),this.settingMenuRootEl.style.display="block"}openSettingSecondLevelMenu(t,e,i){this.clearCloseSettingSubmenusTimer(),this.settingMenuChildEl||(this.settingMenuChildEl=this.createSettingSubmenuContainer("cw-setting-submenu-child")),this.settingMenuChildEl.empty();for(let r of e.h1Options){let n=this.settingMenuChildEl.createDiv({cls:"cw-setting-submenu-item"}),s=n.createSpan({cls:"cw-setting-submenu-item-icon"});(0,S.setIcon)(s,"heading-1"),n.createSpan({text:r.label,cls:"cw-setting-submenu-label"}),n.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),n.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),n.addEventListener("click",()=>{this.appendSelectionAsH2(e.file,r.lineNumber,i)})}this.placeMenuBesideAnchor(this.settingMenuChildEl,t,2,this.settingMenuExpandDirection),this.settingMenuChildEl.style.display="block"}async appendSelectionAsH2(t,e,i){var h,c;let r=i.replace(/\s+/g," ").trim();if(!r)return;let s=(await this.app.vault.read(t)).split(`
`),o=Math.max(0,Math.min(e,s.length-1)),l=s.length;for(let d=o+1;d<s.length;d++){let p=(c=(h=s[d])==null?void 0:h.trim())!=null?c:"";if(p.startsWith("# ")&&!p.startsWith("## ")){l=d;break}}s.splice(l,0,`## ${r}`),await this.app.vault.modify(t,s.join(`
`)),this.updateH3CacheForSettingFile(t.path),this.highlightManager.clearCache(),await this.smartUpdateView(),new S.Notice(`\u5DF2\u6DFB\u52A0\u5230\uFF1A${t.basename}`),this.closeSettingSubmenus()}placeMenuWithinViewport(t,e,i){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let r=t.getBoundingClientRect(),n=8,s=Math.min(Math.max(n,e),Math.max(n,window.innerWidth-r.width-n)),o=Math.min(Math.max(n,i),Math.max(n,window.innerHeight-r.height-n));t.style.left=`${s}px`,t.style.top=`${o}px`,t.style.visibility="visible"}placeMenuBesideAnchor(t,e,i,r){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let n=t.getBoundingClientRect(),s=8,o=r==="right"?e.right+i:e.left-n.width-i;(o+n.width>window.innerWidth-s||o<s)&&(o=r==="right"?e.left-n.width-i:e.right+i),(o+n.width>window.innerWidth-s||o<s)&&(o=e.left-n.width-i),o=Math.min(Math.max(s,o),Math.max(s,window.innerWidth-n.width-s));let l=e.top;l+n.height>window.innerHeight-s&&(l=window.innerHeight-n.height-s),l=Math.max(s,l),t.style.left=`${o}px`,t.style.top=`${l}px`,t.style.visibility="visible"}pickMenuExpandDirection(t,e){let r=this.measureMenuWidth(t),n=this.measureMenuClassWidth("cw-setting-submenu cw-setting-submenu-child"),s=r+2+n,o=window.innerWidth-e.right-8,l=e.left-8,h=o>=s,c=l>=s;return h&&c||h?"right":c?"left":o>=l?"right":"left"}measureMenuWidth(t){t.style.visibility="hidden",t.style.display="block",t.style.left="0px",t.style.top="0px";let e=t.getBoundingClientRect().width;return t.style.display="none",t.style.visibility="visible",e}measureMenuClassWidth(t){let e=document.body.createDiv({cls:t});e.style.visibility="hidden",e.style.display="block",e.style.left="0px",e.style.top="0px";let i=e.getBoundingClientRect().width;return e.remove(),i}createPointAnchorRect(t,e){return new DOMRect(t,e,0,0)}createSettingSubmenuContainer(t){let e=document.body.createDiv({cls:`cw-setting-submenu ${t}`});return e.addEventListener("mouseenter",()=>this.clearCloseSettingSubmenusTimer()),e.addEventListener("mouseleave",()=>this.scheduleCloseSettingSubmenus()),e}closeSettingChildMenu(){this.settingMenuChildEl&&(this.settingMenuChildEl.style.display="none",this.settingMenuChildEl.empty())}closeSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuRootEl&&(this.settingMenuRootEl.remove(),this.settingMenuRootEl=null),this.settingMenuChildEl&&(this.settingMenuChildEl.remove(),this.settingMenuChildEl=null)}scheduleCloseSettingSubmenus(){this.clearCloseSettingSubmenusTimer(),this.settingMenuCloseTimer=window.setTimeout(()=>this.closeSettingSubmenus(),180)}clearCloseSettingSubmenusTimer(){this.settingMenuCloseTimer!==null&&(window.clearTimeout(this.settingMenuCloseTimer),this.settingMenuCloseTimer=null)}async rebuildAllH3TitleCache(){this.h3TitleCacheByFolder.clear();let t=this.settings.folderMappings.map(e=>e.settingFolder).filter(e=>!!e);await Promise.all(t.map(e=>this.rebuildH3TitleCacheForFolder(e)))}async rebuildH3TitleCacheForFolder(t){let e=new Set,i=this.parser.getMarkdownFilesInFolder(t),r=await Promise.all(i.map(n=>this.app.vault.read(n)));for(let n of r){let s=n.split(`
`);for(let o of s){let l=o.trim(),h=l.startsWith("## ")&&!l.startsWith("### "),c=l.startsWith("### ")&&!l.startsWith("#### ");if(h||c){let d=h?3:4,p=l.slice(d).replace(/\s+/g," ").trim();p&&e.add(p)}}}this.h3TitleCacheByFolder.set(t,e)}hasH3InSettingFolder(t,e){let i=this.h3TitleCacheByFolder.get(t);if(!i)return!1;let r=e.replace(/\s+/g," ").trim();return i.has(r)}updateH3CacheForSettingFile(t){let e=this.findSettingFolderByFilePath(t);e&&this.rebuildH3TitleCacheForFolder(e)}findSettingFolderByFilePath(t){for(let e of this.settings.folderMappings)if(e.settingFolder&&t.startsWith(`${e.settingFolder}/`))return e.settingFolder;return null}async syncOrderOnFileCreate(t){let e=null;for(let r of this.settings.folderMappings)if(r.settingFolder&&t.path.startsWith(r.settingFolder+"/")){e=r.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0?i=this.parser.getMarkdownFilesInFolder(e).map(n=>n.path):i.includes(t.path)||i.push(t.path),await this.orderManager.setFileOrder(i),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileDelete(t){let e=null;for(let n of this.settings.folderMappings)if(n.settingFolder&&t.path.startsWith(n.settingFolder+"/")){e=n.settingFolder;break}if(!e){await this.smartUpdateView();return}let i=this.orderManager.getFileOrder();i.length===0&&(i=this.parser.getMarkdownFilesInFolder(e).map(s=>s.path));let r=i.indexOf(t.path);r!==-1&&(i.splice(r,1),await this.orderManager.setFileOrder(i)),setTimeout(()=>{this.smartUpdateView()},400)}async syncOrderOnFileRename(t,e){let i=null,r=!1,n=!1;for(let o of this.settings.folderMappings)o.settingFolder&&(e.startsWith(o.settingFolder+"/")&&(r=!0,i=o.settingFolder),t.path.startsWith(o.settingFolder+"/")&&(n=!0,i=o.settingFolder));if(!r&&!n){await this.smartUpdateView();return}if(!i){await this.smartUpdateView();return}let s=this.orderManager.getFileOrder();if(s.length===0)s=this.parser.getMarkdownFilesInFolder(i).map(l=>l.path);else{let o=s.indexOf(e);o!==-1?n?s[o]=t.path:s.splice(o,1):n&&s.push(t.path)}await this.orderManager.setFileOrder(s),setTimeout(()=>{this.smartUpdateView()},400)}};
